{% extends "base/base.html" %}
{% load static %}

{% block title %}Automation · Data Management{% endblock %}

{% block head_css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/automation.css' %}">
{% endblock %}

{% block content %}
<div class="automation-dashboard" id="data-management-app">
    <div class="automation-grid data-management-grid">
        <section class="automation-panel data-card" data-entity="test-modules" data-section="test-modules" aria-labelledby="headline-test-modules" id="section-test-modules">
            <div class="panel-header">
                <div>
                    <h3 id="headline-test-modules">Test Modules</h3>
                    <p class="panel-subtitle">Register modules under test to organise test plans and cases.</p>
                </div>
                <div class="panel-actions">
                    <input type="search" class="automation-search" placeholder="Search modules" data-role="test-modules-search" aria-label="Search modules">
                    <select id="test-modules-filter-project" class="inline-select" aria-label="Filter by project">
                        <option value="">All projects</option>
                    </select>
                    {% if perms.accounts.can_create_project_module %}
                    <button type="button" class="btn-primary" data-action="open-test-modules-modal">New Module</button>
                    {% endif %}
                </div>
            </div>
            <div class="card table-card automation-table-card" aria-live="polite">
                <table class="table-modern automation-table" aria-label="Test modules register">
                    <thead>
                        <tr>
                            <th scope="col" class="col-collapse" aria-hidden="true"></th>
                            <th scope="col">Title</th>
                            <th scope="col">Description</th>
                            <th scope="col">Project</th>
                            <th scope="col">Created</th>
                            <th scope="col">Updated</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody data-role="test-modules-list">
                        <tr>
                            <td colspan="7" class="empty">No test modules registered yet. Add one to the registry.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <div class="automation-modal" data-role="test-modules-modal" hidden>
        <div class="automation-modal__backdrop" data-action="close-test-modules-modal"></div>
        <div class="automation-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="test-modules-modal-title">
            <header class="automation-modal__header">
                <h2 id="test-modules-modal-title">New Test Module</h2>
                <button type="button" class="automation-modal__close" data-action="close-test-modules-modal" aria-label="Close test modules modal">&times;</button>
            </header>
            <form id="test-modules-form" class="automation-form" autocomplete="off">
                <fieldset>
                    <legend class="sr-only">Module details</legend>
                    <div class="form-row">
                        <label for="test-modules-title">Title<span aria-hidden="true">*</span></label>
                        <input type="text" id="test-modules-title" name="title" required maxlength="255" placeholder="User Management">
                    </div>
                    <div class="form-row">
                        <label for="test-modules-description">Description</label>
                        <textarea id="test-modules-description" name="description" rows="3" placeholder="Describe the module under test."></textarea>
                    </div>
                    <div class="form-row">
                        <label for="test-modules-project">Project</label>
                        <select id="test-modules-project" name="project">
                            <option value="">— Select project —</option>
                        </select>
                    </div>
                </fieldset>
                <div class="form-meta" data-role="test-modules-meta" hidden>
                    <div class="form-meta__entry">
                        <span class="form-meta__label">Created</span>
                        <span class="form-meta__value"><time data-role="test-modules-created">&mdash;</time></span>
                    </div>
                    <div class="form-meta__entry">
                        <span class="form-meta__label">Updated</span>
                        <span class="form-meta__value"><time data-role="test-modules-updated">&mdash;</time></span>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary" data-role="test-modules-submit">Save</button>
                    <button type="button" class="btn-secondary" data-action="close-test-modules-modal">Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Scenario modal (used for adding a scenario directly to a module) -->
    <div class="automation-modal" data-role="module-add-scenario-modal" hidden>
        <div class="automation-modal__backdrop" data-action="close-module-add-scenario-modal"></div>
        <div class="automation-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="module-add-scenario-modal-title">
            <header class="automation-modal__header">
                <h2 id="module-add-scenario-modal-title">Add Scenario to Module</h2>
                <button type="button" class="automation-modal__close" data-action="close-module-add-scenario-modal" aria-label="Close">&times;</button>
            </header>
            <form id="module-add-scenario-form" class="automation-form" autocomplete="off">
                <fieldset>
                    <legend class="sr-only">New scenario</legend>
                    <input type="hidden" id="module-add-scenario-module-id" name="module">
                    <div class="form-row">
                        <label for="module-add-scenario-title">Title<span aria-hidden="true">*</span></label>
                        <input type="text" id="module-add-scenario-title" name="title" required maxlength="150" placeholder="Scenario title">
                    </div>
                    <div class="form-row">
                        <label for="module-add-scenario-description">Description</label>
                        <textarea id="module-add-scenario-description" name="description" rows="12" placeholder="Short summary"></textarea>
                    </div>
                    <div class="form-actions" id="module-view-scenario-save-row" hidden>
                        <button type="button" class="btn-primary" data-action="submit-view-scenario-save">Save Scenario</button>
                        <button type="button" class="btn-secondary" data-action="cancel-view-scenario-edit">Cancel</button>
                    </div>

                    <div class="form-row" id="module-view-scenario-comments-row" hidden style="height: 1000px; display: flex; flex-direction: column;">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 8px;">
                            <span style="font-weight: 600;">COMMENTS</span>
                            <button type="button" class="btn-primary" data-action="toggle-view-scenario-add-comment">Add Comment</button>
                        </div>
                        <input
                            type="file"
                            id="module-view-scenario-comment-attachments-input"
                            name="scenario_comment_attachments"
                            multiple
                            hidden
                            accept="image/*,video/*,.csv,.xls,.xlsx,.pdf,.doc,.docx"
                        >
                        <div id="module-view-scenario-add-comment-form" class="automation-form" style="display:none; margin-bottom: 12px;">
                            <input type="hidden" id="module-view-scenario-comment-scenario-id" name="scenario">
                            <div class="form-row">
                                <textarea id="module-view-scenario-comment-content" name="content" rows="6" placeholder="Write your comment here..." class="tinymce-editor"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn-primary" data-action="post-view-scenario-add-comment">Post Comment</button>
                                <button type="button" class="btn-secondary" data-action="cancel-view-scenario-add-comment">Cancel</button>
                            </div>
                        </div>
                        <div id="module-view-scenario-comments" style="flex: 1 1 auto; overflow-y: auto;"></div>
                    </div>
                    <div class="form-row dependency-toggle">
                        <label class="dependency-toggle__label" for="module-add-scenario-is-automated">
                            <input type="checkbox" id="module-add-scenario-is-automated" name="is_automated" checked>
                            <span>Automated scenario (included in RUN)</span>
                        </label>
                    </div>
                </fieldset>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Save Scenario</button>
                    <button type="button" class="btn-secondary" data-action="close-module-add-scenario-modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Test Case modal (used for adding a case directly to a scenario) -->
    <div class="automation-modal" data-role="module-add-case-modal" hidden>
        <div class="automation-modal__backdrop" data-action="close-module-add-case-modal"></div>
        <div class="automation-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="module-add-case-modal-title">
            <header class="automation-modal__header">
                <h2 id="module-add-case-modal-title">Add Test Case</h2>
                <button type="button" class="automation-modal__close" data-action="close-module-add-case-modal" aria-label="Close">&times;</button>
            </header>
            <form id="module-add-case-form" class="automation-form" autocomplete="off">
                <fieldset>
                    <legend class="sr-only">New test case</legend>
                    <input type="hidden" id="module-add-case-scenario-id" name="scenario">
                    <div class="form-row">
                        <label for="module-add-case-title">Title<span aria-hidden="true">*</span></label>
                        <input type="text" id="module-add-case-title" name="title" required maxlength="150" placeholder="Case title">
                    </div>
                    <div class="form-row">
                        <label for="module-add-case-description">Description</label>
                        <textarea id="module-add-case-description" name="description" rows="3"></textarea>
                    </div>
                    <div class="form-row">
                        <label for="module-add-case-steps">Steps (one per line)</label>
                        <textarea id="module-add-case-steps" name="steps" rows="4" placeholder="Step 1\nStep 2"></textarea>
                    </div>
                    <div class="form-row">
                        <label for="module-add-case-expected">Expected results (key: value per line)</label>
                        <textarea id="module-add-case-expected" name="expected" rows="4" placeholder="response.status_code: 200
response.json.project: premium
# Optional note"></textarea>
                    </div>
                        <div class="form-row">
                            <label for="module-add-case-priority">Priority</label>
                            <input type="text" id="module-add-case-priority" name="priority" placeholder="P1">
                        </div>
                    <div class="form-row">
                        <label class="checkbox" for="module-add-case-requires-dependency">
                            <input type="checkbox" id="module-add-case-requires-dependency" name="requires_dependency">
                            Require dependency test case before running
                        </label>
                    </div>
                    <div class="form-row dependency-settings" data-role="dependency-fields" hidden>
                        <label for="module-add-case-dependency-id">Dependency test case</label>
                        <select id="module-add-case-dependency-id" name="test_case_dependency">
                            <option value="">(no dependency)</option>
                        </select>
                        <small class="form-hint">Only cases from the same scenario can be selected.</small>
                    </div>
                    <div class="form-row dependency-settings" data-role="dependency-fields" hidden>
                        <label for="module-add-case-dependency-key">Required dependency response key</label>
                        <input type="text" id="module-add-case-dependency-key" name="dependency_response_key" placeholder="response.data.token" disabled>
                        <small class="form-hint">The JSON key that must exist in the dependency response.</small>
                    </div>
                                <!-- Related API Request input removed: use explorer to choose a request -->
                                <input type="hidden" id="module-add-case-related-api-request-id" name="related_api_request" value="">
                                <div class="form-row">
                                    <button type="button" id="module-open-api-explorer" class="btn-secondary">Choose Related API Request</button>
                                    <small id="module-related-api-request-label" class="form-hint">No API request selected</small>
                                </div>
                </fieldset>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Save Test Case</button>
                    <button type="button" class="btn-secondary" data-action="close-module-add-case-modal">Cancel</button>
                </div>
            </form>

            <div class="form-row" id="module-view-case-comments-row" hidden style="height: 1000px; display: flex; flex-direction: column;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 8px;">
                    <span style="font-weight: 600;">COMMENTS</span>
                    <button type="button" class="btn-primary" data-action="toggle-view-case-add-comment">Add Comment</button>
                </div>
                <input
                    type="file"
                    id="module-view-case-comment-attachments-input"
                    name="comment_attachments"
                    multiple
                    hidden
                    accept="image/*,video/*,.csv,.xls,.xlsx,.pdf,.doc,.docx"
                >
                <div id="module-view-case-add-comment-form" class="automation-form" style="display:none; margin-bottom: 12px;">
                    <input type="hidden" id="module-view-case-comment-case-id" name="test_case">
                    <div class="form-row">
                        <textarea id="module-view-case-comment-content" name="content" rows="6" placeholder="Write your comment here..." class="tinymce-editor"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-primary" data-action="post-view-case-add-comment">Post Comment</button>
                        <button type="button" class="btn-secondary" data-action="cancel-view-case-add-comment">Cancel</button>
                    </div>
                </div>
                <div id="module-view-case-comments" style="flex: 1 1 auto; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    {{ initial_metrics|default:"[]"|json_script:"data-management-initial-metrics" }}
    {{ api_endpoints|default:"{}"|json_script:"automation-api-endpoints" }}
    {{ initial_plans|default:"[]"|json_script:"automation-initial-plans" }}
    {{ initial_section|default:""|json_script:"data-management-initial-section" }}

</div>
{% endblock %}

{% block body_js %}
    {{ block.super }}
    <script src="{% static 'tinymce/tinymce.min.js' %}"></script>
    <script src="{% static 'js/data_management.js' %}"></script>
{% endblock %}
