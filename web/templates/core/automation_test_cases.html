{% extends "base/base.html" %}
{% load static %}

{% block title %}Automation · Test Cases{% endblock %}

{% block head_css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/automation.css' %}">
    <style>
        .comment-item {
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            background: #f6f8fa;
        }
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
            color: #586069;
        }
        .comment-author {
            font-weight: 600;
            color: #24292e;
        }
        .comment-content {
            color: #24292e;
            line-height: 1.5;
            word-wrap: break-word;
            white-space: pre-wrap;
            font-size: 0.85rem;
            font-family: inherit;
        }
        .comment-content p {
            margin: 0 0 10px 0;
        }
        .comment-content ul, .comment-content ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .comment-content code {
            background: #f6f8fa;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
        }
        .comment-content pre {
            background: #f6f8fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        .comment-empty {
            text-align: center;
            padding: 40px;
            color: #586069;
            font-style: italic;
        }
        .comment-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e1e4e8;
        }
        .comment-action-btn {
            background: transparent;
            border: none;
            color: #586069;
            font-size: 13px;
            padding: 4px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
            position: relative;
        }
        .comment-action-btn:hover {
            background-color: #e1e4e8;
            color: #24292e;
        }
        .comment-action-btn-inactive .like-icon {
            filter: grayscale(100%) opacity(0.4);
        }
        .comment-action-btn-active {
            color: #0366d6;
        }
        .comment-action-btn-active:hover {
            background-color: #e1e4e8;
        }
        .comment-action-btn span {
            font-size: 16px;
            pointer-events: none;
        }
        .comment-action-btn::after {
            content: attr(title);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #6c757d;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            margin-top: 5px;
            z-index: 1000;
        }
        .comment-action-btn:hover::after {
            opacity: 1;
        }
        .comment-replies {
            margin-top: 15px;
            margin-left: 30px;
            padding-left: 15px;
            border-left: 3px solid #d1d5da;
        }
        .comment-reply {
            background: #ffffff;
            border: 1px solid #d1d5da;
        }
        .btn-icon {
            background: transparent;
            border: 1px solid #d1d5da;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .btn-icon:hover {
            background-color: #f6f8fa;
            border-color: #586069;
        }
    </style>
{% endblock %}

{% block content %}
<div class="automation-dashboard" id="automation-app" data-current-user-id="{% if request.user.is_authenticated %}{{ request.user.id }}{% else %}null{% endif %}">

    <div class="automation-grid">
        <div id="test-cases-panel-container">
        <section class="automation-panel data-card" data-panel="cases" aria-labelledby="headline-cases">
            <div class="panel-header">
                <h2 id="headline-cases">Test Cases</h2>
                <div class="panel-controls case-controls">
                    <div class="case-controls__filters">
                        <div class="case-filter-group" role="group" aria-label="Filter test cases">
                            <label for="case-filter-project" class="sr-only">Project</label>
                            <select id="case-filter-project" class="case-filter-input">
                                <option value="">Select project</option>
                            </select>
                            <label for="case-filter-module" class="sr-only">Module</label>
                            <select id="case-filter-module" class="case-filter-input" disabled>
                                <option value="">Select module</option>
                            </select>
                            <label for="case-filter-scenario" class="sr-only">Scenario</label>
                            <select id="case-filter-scenario" class="case-filter-input" disabled>
                                <option value="">Select scenario</option>
                            </select>
                        </div>
                    </div>
                    <div class="case-controls__actions">
                        <input type="search" id="case-search" class="automation-search" placeholder="Search cases" aria-label="Search cases">
                        <button type="button" class="btn-primary" id="open-new-case">New Test Case</button>
                    </div>
                </div>
            </div>
            <div class="card table-card automation-table-card" aria-live="polite">
            <div class="automation-list" data-role="case-list" aria-live="polite">
                <button type="button" id="run-cases-btn" class="btn-primary" style="display:none;margin-bottom:12px;">Run Selected Case</button>
                {% if initial_selected_scenario and initial_selected_scenario.cases %}
                    <table class="table-modern automation-table" aria-label="Test cases">
                        <thead>
                            <tr>
                                <th scope="col" class="col-checkbox">
                                    <label class="case-checkbox-label">
                                        <input id="select-all-cases" type="checkbox" aria-label="Select all test cases">
                                        <span class="fake-checkbox" aria-hidden="true"></span>
                                    </label>
                                </th>
                                <th scope="col">ID</th>
                                <th scope="col">Title</th>
                                <th scope="col">Description</th>
                                <th scope="col">Created</th>
                                <th scope="col">Updated</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody data-role="case-table-body">
                            {% for test_case in initial_selected_scenario.cases %}
                                <tr data-case-id="{{ test_case.id }}" data-response-encrypted="{% if test_case.is_response_encrypted %}true{% else %}false{% endif %}" data-requires-dependency="{% if test_case.requires_dependency %}true{% else %}false{% endif %}" data-dependency-id="{{ test_case.test_case_dependency|default_if_none:'' }}" data-dependency-key="{{ test_case.dependency_response_key|default_if_none:'' }}">
                                    <td>
                                        <label class="case-checkbox-label">
                                            <input type="checkbox" class="case-checkbox" data-case-id="{{ test_case.id }}" aria-label="Select test case {{ test_case.testcase_id|default:test_case.id }}">
                                            <span class="fake-checkbox" aria-hidden="true"></span>
                                        </label>
                                    </td>
                                    <td>{{ test_case.testcase_id|default:test_case.id }}</td>
                                    <td>{{ test_case.title|default:"Untitled case" }}</td>
                                    <td>{{ test_case.description|truncatechars:120 }}</td>
                                    <td>{{ test_case.created_at }}</td>
                                    <td>{{ test_case.updated_at }}</td>
                                    <td>
                                        <div class="table-action-group">
                                            <button type="button" class="action-button" data-action="view-case" data-case-id="{{ test_case.id }}" data-related-api-request-name="{{ test_case.related_api_request_name|default:'' }}">View</button>
                                            <button type="button" class="action-button" data-action="edit-case" data-case-id="{{ test_case.id }}" data-related-api-request-name="{{ test_case.related_api_request_name|default:'' }}">Edit</button>
                                                    {% if test_case.related_api_request %}
                                                        <button type="button" class="action-button" data-action="run-case" data-case-id="{{ test_case.id }}" data-request-id="{{ test_case.related_api_request }}" data-environment-id="1" data-response-encrypted="{% if test_case.is_response_encrypted %}true{% else %}false{% endif %}" data-requires-dependency="{% if test_case.requires_dependency %}true{% else %}false{% endif %}" data-dependency-id="{{ test_case.test_case_dependency|default_if_none:'' }}" data-dependency-key="{{ test_case.dependency_response_key|default_if_none:'' }}" {% if test_case.requires_dependency %}disabled aria-disabled="true" data-dependency-tooltip="Requires dependency" title="Run disabled: this test case requires a dependency to execute individually."{% else %}title="Run related API request" onclick="if (window.__automationTestcaseControls) { window.__automationTestcaseControls.runCaseFromElement(this); }"{% endif %}>Run</button>
                                                    {% endif %}
                                            <button type="button" class="action-button" data-action="delete-case" data-case-id="{{ test_case.id }}" data-variant="danger">Delete</button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% elif initial_selected_scenario %}
                    <p class="empty">No test cases found. Capture one using the form below.</p>
                {% else %}
                    <p class="empty">Select a scenario to view its test cases.</p>
                {% endif %}
            </div>
            </div>
        </section>
    </div> {# end #test-cases-panel-container #}
    </div> {# end .automation-grid #}

    <!-- Add Test Case modal (copied from data management) -->
    <div class="automation-modal" data-role="module-add-case-modal" hidden>
        <div class="automation-modal__backdrop" data-action="close-module-add-case-modal"></div>
        <div class="automation-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="module-add-case-modal-title">
            <header class="automation-modal__header">
                <h2 id="module-add-case-modal-title">Add Test Case</h2>
                <button type="button" class="automation-modal__close" data-action="close-module-add-case-modal" aria-label="Close">&times;</button>
            </header>
            <form id="module-add-case-form" class="automation-form" autocomplete="off">
                <fieldset>
                    <legend class="sr-only">New test case</legend>
                    <input type="hidden" id="module-add-case-scenario-id" name="scenario">
                    <div class="form-row">
                        <label for="module-add-case-title">Title<span aria-hidden="true">*</span></label>
                        <input type="text" id="module-add-case-title" name="title" required maxlength="150" placeholder="Case title">
                    </div>
                    <div class="form-row">
                        <label for="module-add-case-description">Description</label>
                        <textarea id="module-add-case-description" name="description" rows="3"></textarea>
                    </div>

                    <div class="form-row">
                        <label for="module-add-case-steps">Steps (one per line)</label>
                        <textarea id="module-add-case-steps" name="steps" rows="4" placeholder="Step 1\nStep 2"></textarea>
                    </div>
                    <div class="form-row">
                        <label for="module-add-case-expected">Expected results (key: value per line)</label>
                        <textarea id="module-add-case-expected" name="expected" rows="4" placeholder="response.status_code: 200
response.json.plan: premium
# Optional note"></textarea>
                    </div>
                    <div class="form-row">
                        <label for="module-add-case-precondition">Preconditions</label>
                        <textarea id="module-add-case-precondition" name="precondition" rows="2" placeholder="Any setup or state required before executing this test."></textarea>
                    </div>
                    <div class="form-row">
                        <label for="module-add-case-requirements">Requirements</label>
                        <textarea id="module-add-case-requirements" name="requirements" rows="2" placeholder="Linked requirement IDs or description."></textarea>
                    </div>
                    <div class="form-row">
                        <label for="module-add-case-priority">Priority</label>
                        <input type="text" id="module-add-case-priority" name="priority" placeholder="P1">
                    </div>
                    <div class="form-row dependency-toggle">
                        <label class="dependency-toggle__label" for="module-add-case-response-encrypted">
                            <input type="checkbox" id="module-add-case-response-encrypted" name="is_response_encrypted">
                            <span>Response body requires post-request decryption</span>
                        </label>
                        <small class="form-hint">Expected results will be matched against data exposed as "Decrypted Data" by the post-request script.</small>
                    </div>
                    <div class="form-row dependency-toggle">
                        <label class="dependency-toggle__label" for="module-add-case-requires-dependency">
                            <input type="checkbox" id="module-add-case-requires-dependency" name="requires_dependency">
                            <span>Require dependency test case before running</span>
                        </label>
                    </div>
                    <div class="form-row dependency-settings" data-role="dependency-fields" hidden>
                        <label for="module-add-case-dependency-id">Dependency test case</label>
                        <select id="module-add-case-dependency-id" name="test_case_dependency" disabled>
                            <option value="">(no dependency)</option>
                        </select>
                        <small class="form-hint">Only cases within the selected scenario are available.</small>
                    </div>
                    <div class="form-row dependency-settings" data-role="dependency-fields" hidden>
                        <label for="module-add-case-dependency-key">Required dependency response key</label>
                        <input type="text" id="module-add-case-dependency-key" name="dependency_response_key" placeholder="response.data.token" disabled>
                        <small class="form-hint">Specify the JSON key that must exist in the dependency response.</small>
                    </div>
                    <input type="hidden" id="module-add-case-related-api-request-id" name="related_api_request" value="">
                    <div class="form-row">
                        <button type="button" id="module-open-api-explorer" class="btn-secondary">Choose Related API Request</button>
                        <small id="module-related-api-request-label" class="form-hint">No API request selected</small>
                    </div>
                </fieldset>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Save Test Case</button>
                </div>
                
            </form>

                    <div class="form-row" id="module-view-case-comments-row" hidden style="max-height: 600px; overflow-y: auto;">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 8px;">
                            <span style="font-weight: 600;">COMMENTS</span>
                            <button type="button" class="btn-primary" data-action="toggle-view-case-add-comment">Add Comment</button>
                        </div>
                        <input
                            type="file"
                            id="module-view-case-comment-attachments-input"
                            name="comment_attachments"
                            multiple
                            hidden
                            accept="image/*,video/*,.csv,.xls,.xlsx,.pdf,.doc,.docx"
                        >
                        <div id="module-view-case-add-comment-form" class="automation-form" style="display:none; margin-bottom: 12px;">
                            <input type="hidden" id="module-view-case-comment-case-id" name="test_case">
                            <div class="form-row">
                                <textarea id="module-view-case-comment-content" name="content" rows="6" placeholder="Write your comment here..." class="tinymce-editor"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn-primary" data-action="post-view-case-add-comment">Post Comment</button>
                                <button type="button" class="btn-secondary" data-action="cancel-view-case-add-comment">Cancel</button>
                            </div>
                        </div>
                        <div id="module-view-case-comments"></div>
                    </div>
        </div>
        
    </div>

    {{ initial_plans|json_script:"automation-initial-plans" }}
    {{ api_endpoints|json_script:"automation-api-endpoints" }}
    {{ initial_metrics|json_script:"automation-initial-metrics" }}
    {{ initial_selected_plan|json_script:"automation-initial-selected-plan" }}
    {{ initial_selected_scenario|json_script:"automation-initial-selected-scenario" }}
    {{ initial_modules|default:"[]"|json_script:"automation-initial-modules" }}
</div>
<!-- Hidden response modal reused from API tester layout (minimal) -->
<div class="modal" id="testcase-response-modal" hidden aria-hidden="true" tabindex="-1">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="testcase-response-title">
        <div class="modal-header">
            <h3 id="testcase-response-title">Request Response</h3>
                <button type="button" id="testcase-response-close" class="modal-close" aria-label="Close">×</button>
        </div>
        <div class="modal-body">
            <div id="testcase-response-loading" class="response-loading">Running request…</div>
                <div id="testcase-response-content" hidden>
                <div id="testcase-response-summary" class="response-summary">No request executed yet.</div>
                <div class="response-section">
                    <h4>Headers</h4>
                    <div class="response-section-controls">
                        <button type="button" class="action-button" data-action="toggle-section" data-target="testcase-response-headers">Toggle</button>
                    </div>
                    <pre id="testcase-response-headers" class="response-pre expandable" data-min-height="80">{}</pre>
                </div>
                <div class="response-section">
                    <div class="response-section__header">
                        <h4>Body</h4>
                        <div class="response-body__controls" role="group" aria-label="Response body view options">
                            <div class="response-body__views" role="group" aria-label="Format type">
                                <button type="button" class="response-body__view-button is-active" data-response-body-view="json" aria-pressed="true">JSON</button>
                                <button type="button" class="response-body__view-button" data-response-body-view="xml" aria-pressed="false">XML</button>
                                <button type="button" class="response-body__view-button" data-response-body-view="html" aria-pressed="false">HTML</button>
                            </div>
                            <div class="response-body__modes" role="group" aria-label="Display mode">
                                <button type="button" class="response-body__mode-button is-active" data-response-body-mode="pretty" aria-pressed="true">Pretty</button>
                                <button type="button" class="response-body__mode-button" data-response-body-mode="preview" aria-pressed="false">Preview</button>
                            </div>
                        </div>
                    </div>
                    <div class="response-body__content">
                        <pre id="testcase-response-body" class="response-pre expandable" data-min-height="100">{}</pre>
                        <div class="resizer" data-resize-target="testcase-response-body" title="Drag to resize"></div>
                        <iframe id="testcase-response-preview" class="response-preview" title="Response preview" hidden></iframe>
                    </div>
                </div>
                <div class="response-section">
                    <h4>Assertions</h4>
                    <div id="testcase-response-assertions" class="assertions-list"></div>
                </div>
                <div class="response-section">
                    <div class="response-section__header">
                        <h4>Pre-request Console</h4>
                        <div class="response-section-controls">
                            <button type="button" class="action-button" data-action="toggle-section" data-target="testcase-pre-request-logs">Toggle</button>
                        </div>
                    </div>
                    <pre id="testcase-pre-request-logs" class="response-pre expandable" data-min-height="60">No pre-request console output.</pre>
                </div>
                <div class="response-section">
                    <div class="response-section__header">
                        <h4>Post-request Console</h4>
                        <div class="response-section-controls">
                            <button type="button" class="action-button" data-action="toggle-section" data-target="testcase-post-request-logs">Toggle</button>
                        </div>
                    </div>
                    <pre id="testcase-post-request-logs" class="response-pre expandable" data-min-height="60">No post-request console output.</pre>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_js %}
    {{ block.super }}
    <script>
        (function () {
            // Robust checkbox handling: listens for change and click events and watches DOM mutations.

            function getRunBtn() { return document.getElementById('run-cases-btn'); }

            function getSelectAll() {
                return document.getElementById('select-all-cases');
            }

            function getRowCheckboxes() {
                return Array.from(document.querySelectorAll('input.case-checkbox'));
            }

            // Simple debounce helper to collapse rapid calls into one.
            function debounce(fn, wait) {
                let timer = null;
                return function debounced() {
                    const ctx = this;
                    const args = arguments;
                    if (timer) clearTimeout(timer);
                    timer = setTimeout(function () {
                        timer = null;
                        try { fn.apply(ctx, args); } catch (e) { /* ignore */ }
                    }, wait);
                };
            }

            function getListNode() {
                return document.querySelector('.automation-list') || document.querySelector('[data-role="case-list"]') || document.body;
            }

            function ensureRunBtn() {
                let btn = getRunBtn();
                if (btn) return btn;
                const list = getListNode();
                if (!list) return null;
                btn = document.createElement('button');
                btn.type = 'button';
                btn.id = 'run-cases-btn';
                btn.className = 'btn-primary';
                btn.textContent = 'Run Selected Case';
                try { btn.style.setProperty('display', 'none', 'important'); btn.style.setProperty('margin-bottom', '12px', 'important'); } catch (e) { btn.style.display = 'none'; btn.style.marginBottom = '12px'; }
                const table = list.querySelector('table');
                if (table && table.parentNode) table.parentNode.insertBefore(btn, table);
                else list.insertBefore(btn, list.firstChild);
                return btn;
            }


            function setRunBtnVisible(visible) {
                const btn = getRunBtn();
                if (!btn) return;
                try {
                    if (visible) {
                        // Force visible with an important inline rule so CSS rules or classes won't hide it.
                        btn.style.setProperty('display', 'inline-block', 'important');
                        btn.removeAttribute('aria-hidden');
                    } else {
                        btn.style.setProperty('display', 'none', 'important');
                        btn.setAttribute('aria-hidden', 'true');
                    }
                } catch (e) { /* ignore */ }
            }

            function updateSelectAllState() {
                // Ensure the run button exists before toggling visibility (some UI code may remove/replace it)
                try { ensureRunBtn(); } catch (e) { /* ignore */ }
                const selectAll = getSelectAll();
                const boxes = getRowCheckboxes();
                // DEBUG: trace state (only when there are boxes or global debug enabled)
                try { if (window.CASES_DEBUG) console.debug('[cases] updateSelectAllState - boxes:', boxes.length); } catch (e) {}

                if (boxes.length === 0) {
                    if (selectAll) {
                        selectAll.checked = false;
                        selectAll.indeterminate = false;
                        selectAll.disabled = true;
                    }
                    setRunBtnVisible(false);
                    try { if (window.CASES_DEBUG) console.debug('[cases] runBtn hidden (no rows)'); } catch (e) {}
                    return;
                }

                if (selectAll) selectAll.disabled = false;

                const checked = boxes.filter(b => b.checked).length;
                try { if (window.CASES_DEBUG) console.debug('[cases] checked count:', checked); } catch (e) {}

                if (selectAll) {
                    selectAll.checked = (checked === boxes.length);
                    selectAll.indeterminate = (checked > 0 && checked < boxes.length);
                    // update visual fake-checkbox if present
                    try {
                        const headerFake = selectAll.parentElement && selectAll.parentElement.querySelector('.fake-checkbox');
                        if (headerFake) {
                            headerFake.classList.toggle('header-indeterminate', selectAll.indeterminate === true);
                            headerFake.classList.toggle('checked', selectAll.checked === true);
                        }
                    } catch (e) { /* ignore */ }
                }

                setRunBtnVisible(checked > 0);

                // Ensure we watch the run button for attribute mutations (so if another script hides it again
                // we reapply the visibility while cases remain checked).
                try { watchRunBtn(); } catch (e) { /* ignore */ }
                try { if (window.CASES_DEBUG) console.debug('[cases] runBtn set visible=', (checked > 0)); } catch (e) {}
            }

            // Catch native change events
            document.addEventListener('change', function (ev) {
                const t = ev.target;
                if (!t) return;
                try { if (window.CASES_DEBUG) console.debug('[cases] change event target=', t && (t.id || t.className || t.getAttribute && t.getAttribute('aria-label'))); } catch (e) {}
                if (t.matches('#select-all-cases')) {
                    const boxes = getRowCheckboxes();
                    boxes.forEach(b => b.checked = t.checked);
                    // dispatch change so other listeners can react
                    boxes.forEach(b => b.dispatchEvent(new Event('change', { bubbles: true })));
                    // schedule a debounced update to collapse per-row change events
                    try { debouncedUpdateSelectAllState(); } catch (e) { updateSelectAllState(); }
                    return;
                }
                if (t.matches('input.case-checkbox')) {
                    // slight delay in case other handlers modify checked state -> use debounced scheduler
                    try { debouncedUpdateSelectAllState(); } catch (e) { setTimeout(updateSelectAllState, 0); }
                }
            });

            // Some UI layers use a styled fake-checkbox that receives the click.
            // Also listen for clicks on the fake-checkbox or its label and refresh state.
            document.addEventListener('click', function (ev) {
                const t = ev.target;
                if (!t) return;
                try { if (window.CASES_DEBUG) console.debug('[cases] click event target=', t && (t.id || t.className)); } catch (e) {}
                if (t.matches('.fake-checkbox') || t.closest('.case-checkbox-label')) {
                    // update after the click causes the native input to toggle; use debounced scheduler
                    try { debouncedUpdateSelectAllState(); } catch (e) { setTimeout(updateSelectAllState, 0); }
                }
            });

            // Observe mutations to the table body (cases are often re-rendered); update state when rows change.
            const tbody = document.querySelector('tbody[data-role="case-table-body"]');
            if (tbody) {
                const mo = new MutationObserver(function () {
                    // re-run state update when rows change (debounced)
                    try { debouncedUpdateSelectAllState(); } catch (e) { setTimeout(updateSelectAllState, 0); }
                });
                mo.observe(tbody, { childList: true, subtree: true });
            }

            // Observe the surrounding automation-list so we detect if the run button is replaced or removed
            const listNode = document.querySelector('.automation-list') || document.querySelector('[data-role="case-list"]');
            if (listNode) {
                const mo2 = new MutationObserver(function () {
                    // re-run state update when DOM under automation-list changes (new run button may be added)
                    try { debouncedUpdateSelectAllState(); } catch (e) { setTimeout(updateSelectAllState, 0); }
                });
                mo2.observe(listNode, { childList: true, subtree: true, attributes: true });
            }

            // Watch the run button for attribute changes and reapply visibility when needed.
            function watchRunBtn() {
                const b = getRunBtn();
                if (!b) return;
                // Avoid attaching multiple observers to same node
                if (b._casesObserver) return;
                try {
                    const o = new MutationObserver(function (ms) {
                        // If cases are checked, ensure the button remains visible.
                        const checked = getRowCheckboxes().filter(bx => bx.checked).length;
                        if (checked > 0) {
                            // reapply visible state (important inline will override CSS)
                            setRunBtnVisible(true);
                        }
                    });
                    o.observe(b, { attributes: true, attributeFilter: ['style', 'class'], attributeOldValue: true });
                    b._casesObserver = o;
                } catch (e) { /* ignore */ }
            }

            // Create debounced scheduler and expose both immediate and debounced functions.
            const debouncedUpdateSelectAllState = debounce(updateSelectAllState, 40);

            // Initial sync
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', updateSelectAllState);
            } else {
                updateSelectAllState();
            }

            // Expose a sync function so other scripts (e.g. automation.js) can delegate to this single implementation.
            try {
                window.syncCaseSelectionState = updateSelectAllState; // immediate
                window.scheduleCaseSelectionState = debouncedUpdateSelectAllState; // debounced scheduler
            } catch (e) { /* ignore */ }
        })();
    </script>
    <script src="{% static 'tinymce/tinymce.min.js' %}"></script>
    <script src="{% static 'js/api_tester.js' %}"></script>
    <script src="{% static 'js/automation.js' %}"></script>
    <script src="{% static 'js/testcase-runner.js' %}"></script>
    <script src="{% static 'js/testcase-multiple-runner.js' %}"></script>
{% endblock %}
