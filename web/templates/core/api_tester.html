{% extends 'base/dashboard_base.html' %}
{% load static %}

{% block head_css %}
{{ block.super }}
{% endblock %}

{% block dashboard_title %}API Tester{% endblock %}

{% block dashboard_content %}
<div id="api-tester-app"
     class="api-tester"
    data-collections-url="{% url 'core:core-collections-list' %}"
    data-environments-url="{% url 'core:core-environments-list' %}"
    data-requests-url="{% url 'core:core-requests-list' %}"
    data-directories-url="{% url 'core:core-directories-list' %}"
    data-collections-import-url="{% url 'core:core-collections-import-postman' %}"
    data-run-url-template="{% url 'core:core-collections-run' pk=0 %}"
    data-execute-url="{% url 'core:core-request-execute' %}">
    <section class="api-tester__panel api-tester__collections">
        <header>
            <div class="api-tester__collections-title">
                <h2>Collections</h2>
                <div class="collections-actions-wrapper">
                    <button type="button"
                            id="collections-actions-toggle"
                            class="collections-actions-toggle"
                            aria-haspopup="true"
                            aria-expanded="false"
                            aria-controls="collections-actions-menu"
                            aria-label="Collections actions">
                        <span aria-hidden="true">...</span>
                    </button>
                    <div id="collections-actions-menu" class="collections-actions-menu" hidden>
                        <button type="button" id="collections-action-create" class="collections-actions-item">New Collection</button>
                        <button type="button" id="collections-action-import" class="collections-actions-item">Import Postman</button>
                    </div>
                </div>
            </div>
            <input type="file" id="import-postman-input" accept="application/json" hidden />
            <input type="search" id="collection-search" placeholder="Search collections" aria-label="Search collections" />
        </header>
        <div class="api-tester__collections-list" aria-live="polite"></div>
    </section>
    <section class="api-tester__panel api-tester__builder">
        <header class="api-tester__builder-head">
            <div class="api-tester__builder-title-row">
                <h2>Request Builder</h2>
                <div class="api-tester__builder-actions">
                    <label for="environment-select">Environment</label>
                    <select id="environment-select" name="environment">
                        <option value="">No environment</option>
                    </select>
                    <button type="button" id="create-request" class="btn btn-secondary" disabled>New Request</button>
                    <button type="button" id="save-request" class="btn btn-secondary">Save</button>
                </div>
            </div>
            <div class="builder-meta" id="builder-meta">Select a request to preview details.</div>
        </header>
        <form id="api-request-form" class="api-tester__form" autocomplete="off">
            <div class="form-grid form-grid--request">
                <div class="form-field">
                    <label for="request-method">Method</label>
                    <select id="request-method" name="method">
                        <option>GET</option>
                        <option>POST</option>
                        <option>PUT</option>
                        <option>PATCH</option>
                        <option>DELETE</option>
                        <option>HEAD</option>
                        <option>OPTIONS</option>
                    </select>
                </div>
                <div class="form-field form-field--wide">
                    <label for="request-url">URL</label>
                    <input type="text"
                           id="request-url"
                           name="url"
                           placeholder="https://api.example.com/path"
                           required
                           inputmode="url"
                           spellcheck="false" />
                </div>
                <div class="form-field form-field--actions">
                    <div class="form-actions">
                        <button type="submit" id="run-request" class="btn btn-primary" disabled>SEND</button>
                    </div>
                </div>
            </div>
        <nav class="builder-tabs" role="tablist" aria-label="Request builder sections">
        <button type="button"
            class="builder-tab is-active"
            data-tab="params"
            role="tab"
            aria-selected="true"
            aria-controls="builder-panel-params">Params</button>
        <button type="button"
            class="builder-tab"
            data-tab="authorization"
            role="tab"
            aria-selected="false"
            aria-controls="builder-panel-authorization"
            tabindex="-1">Authorization</button>
        <button type="button"
            class="builder-tab"
            data-tab="headers"
            role="tab"
            aria-selected="false"
            aria-controls="builder-panel-headers"
            tabindex="-1">Headers</button>
        <button type="button"
            class="builder-tab"
            data-tab="body"
            role="tab"
            aria-selected="false"
            aria-controls="builder-panel-body"
            tabindex="-1">Body</button>
        <button type="button"
            class="builder-tab"
            data-tab="body-tools"
            role="tab"
            aria-selected="false"
            aria-controls="builder-panel-body-tools"
            tabindex="-1">Body Tools</button>
        <button type="button"
            class="builder-tab"
            data-tab="request"
            role="tab"
            aria-selected="false"
            aria-controls="builder-panel-response"
            tabindex="-1">Response</button>
        </nav>

        <section class="builder-section"
             id="builder-panel-params"
             data-tab-panel="params"
             aria-labelledby="params-heading"
             role="tabpanel"
             aria-hidden="false">
                <header class="builder-section__head builder-section__head--right">
                    <button type="button" id="add-param-row" class="btn btn-tertiary">Add Param</button>
                </header>
                <div class="kv-table" role="table" aria-label="Query parameters">
                    <div class="kv-table__scroll">
                        <table>
                            <colgroup>
                                <col class="kv-col-key">
                                <col class="kv-col-value">
                                <col class="kv-col-description">
                                <col class="kv-col-actions">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th scope="col">Key</th>
                                    <th scope="col">Value</th>
                                    <th scope="col">Description</th>
                                    <th scope="col" aria-hidden="true"></th>
                                </tr>
                            </thead>
                            <tbody id="params-rows"></tbody>
                        </table>
                    </div>
                </div>
                <p class="builder-hint">Params are appended to the URL automatically.</p>
            </section>

            <section class="builder-section"
                     id="builder-panel-authorization"
                     data-tab-panel="authorization"
                     aria-labelledby="auth-heading"
                     role="tabpanel"
                     aria-hidden="true"
                     hidden>
                <div class="auth-controls">
                    <label for="auth-type">Auth Type</label>
                    <select id="auth-type" name="auth-type">
                        <option value="none">No Auth</option>
                        <option value="basic">Basic Auth</option>
                        <option value="bearer">Bearer Token</option>
                    </select>
                </div>
                <div class="auth-fields">
                    <div class="auth-none" data-auth-section="none">
                        <p class="builder-hint">No authorization header will be sent.</p>
                    </div>
                    <div class="auth-basic" data-auth-section="basic" hidden aria-hidden="true">
                        <div class="auth-basic__field form-field">
                            <label for="auth-basic-username">Username</label>
                            <input type="text" id="auth-basic-username" autocomplete="off" />
                        </div>
                        <div class="auth-basic__field form-field">
                            <label for="auth-basic-password">Password</label>
                            <input type="text" id="auth-basic-password" autocomplete="off" />
                        </div>
                    </div>
                    <div class="auth-bearer" data-auth-section="bearer" hidden aria-hidden="true">
                        <div class="form-field">
                            <label for="auth-bearer-token">Bearer Token</label>
                            <textarea id="auth-bearer-token" rows="2" placeholder="Paste access token"></textarea>
                        </div>
                    </div>
                </div>
            </section>

            <section class="builder-section"
                     id="builder-panel-headers"
                     data-tab-panel="headers"
                     aria-labelledby="headers-heading"
                     role="tabpanel"
                     aria-hidden="true"
                     hidden>
                <header class="builder-section__head builder-section__head--right">
                    <button type="button" id="add-header-row" class="btn btn-tertiary">Add Header</button>
                </header>
                <div class="kv-table" role="table" aria-label="Request headers">
                    <div class="kv-table__scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th scope="col">Key</th>
                                    <th scope="col">Value</th>
                                    <th scope="col" aria-hidden="true"></th>
                                </tr>
                            </thead>
                            <tbody id="headers-rows"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section class="builder-section"
                     id="builder-panel-body"
                     data-tab-panel="body"
                     aria-labelledby="body-heading"
                     role="tabpanel"
                     aria-hidden="true"
                     hidden>
                <div class="body-mode-list" role="radiogroup" aria-label="Body type">
                    <label><input type="radio" name="body-mode" value="none" checked /> None</label>
                    <label><input type="radio" name="body-mode" value="form-data" /> form-data</label>
                    <label><input type="radio" name="body-mode" value="urlencoded" /> x-www-form-urlencoded</label>
                    <label><input type="radio" name="body-mode" value="raw" /> raw</label>
                    <label><input type="radio" name="body-mode" value="binary" /> binary</label>
                </div>
                <div class="body-panel" data-body-panel="raw">
                    <div class="form-field">
                        <label for="body-raw-type">Raw Type</label>
                        <select id="body-raw-type" name="body-raw-type">
                            <option value="text">Text</option>
                            <option value="javascript">JavaScript</option>
                            <option value="json" selected>JSON</option>
                            <option value="html">HTML</option>
                            <option value="xml">XML</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label id="body-raw-editor-label">Body</label>
                        <div id="body-raw-editor" class="code-editor" aria-label="Raw body editor" aria-labelledby="body-raw-editor-label"></div>
                    </div>
                </div>
                <div class="body-panel" data-body-panel="form-data" hidden>
                    <div class="builder-section__head builder-section__head--sub builder-section__head--right">
                        <button type="button" id="add-body-form-row" class="btn btn-tertiary">Add Field</button>
                    </div>
                    <div class="kv-table">
                        <div class="kv-table__scroll">
                            <table>
                                <thead>
                                    <tr>
                                        <th scope="col">Key</th>
                                        <th scope="col">Type</th>
                                        <th scope="col">Value</th>
                                        <th scope="col" aria-hidden="true"></th>
                                    </tr>
                                </thead>
                                <tbody id="body-form-rows"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="body-panel" data-body-panel="urlencoded" hidden>
                    <div class="builder-section__head builder-section__head--sub builder-section__head--right">
                        <button type="button" id="add-body-urlencoded-row" class="btn btn-tertiary">Add Field</button>
                    </div>
                    <div class="kv-table">
                        <div class="kv-table__scroll">
                            <table>
                                <thead>
                                    <tr>
                                        <th scope="col">Key</th>
                                        <th scope="col">Value</th>
                                        <th scope="col" aria-hidden="true"></th>
                                    </tr>
                                </thead>
                                <tbody id="body-urlencoded-rows"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="body-panel" data-body-panel="binary" hidden>
                    <div class="form-field">
                        <label for="body-binary-input">Binary File</label>
                        <input type="file" id="body-binary-input" />
                        <p id="body-binary-info" class="builder-hint">No file selected.</p>
                    </div>
                </div>
            </section>

            <section class="builder-section"
                     id="builder-panel-body-tools"
                     data-tab-panel="body-tools"
                     aria-labelledby="body-tools-heading"
                     role="tabpanel"
                     aria-hidden="true"
                     hidden>
                <h3 id="body-tools-heading" class="sr-only">Body Tools</h3>
                <div class="builder-body-tools">
                    <div class="builder-body-tools__group">
                        <header class="builder-section__head builder-section__head--sub builder-section__head--centered">
                            <h3>Field Overrides</h3>
                            <button type="button" id="add-body-override" class="btn btn-tertiary">Add Override</button>
                        </header>
                        <p class="builder-hint">Set a JSON path and replacement value. Paths use dot notation, e.g. <code>transaction.request_id</code>.</p>
                        <div class="kv-table">
                            <div class="kv-table__scroll">
                                <table>
                                    <thead>
                                        <tr>
                                            <th scope="col">Path</th>
                                            <th scope="col">Value</th>
                                            <th scope="col" aria-hidden="true"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="body-overrides-rows"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="builder-body-tools__group">
                        <header class="builder-section__head builder-section__head--sub builder-section__head--centered">
                            <h3>Signature Builders</h3>
                            <button type="button" id="add-body-signature" class="btn btn-tertiary">Add Signature</button>
                        </header>
                        <p class="builder-hint">Generate hashes by combining body fields and literals. Prefix literals with <code>literal:</code> or wrap in quotes.</p>
                        <div class="kv-table">
                            <div class="kv-table__scroll">
                                <table>
                                    <thead>
                                        <tr>
                                            <th scope="col">Target Path</th>
                                            <th scope="col">Algorithm</th>
                                            <th scope="col">Components</th>
                                            <th scope="col">Store As</th>
                                            <th scope="col" aria-hidden="true"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="body-signatures-rows"></tbody>
                                </table>
                            </div>
                        </div>
                        <p class="builder-hint">One component per line. Use <code>path:customer.email</code> for body fields or <code>literal:SECRET</code> for constants.</p>
                    </div>
                </div>
            </section>
        </form>
        <section class="builder-section"
                 id="builder-panel-response"
                 data-tab-panel="request"
                 aria-labelledby="request-panel-heading"
                 role="tabpanel"
                 aria-hidden="true"
                 hidden>
            <h3 id="request-panel-heading" class="sr-only">Request Details</h3>
            <div class="api-tester__response-card" aria-live="polite">
                <header>
                    <div id="response-summary" class="response-summary">No request executed yet.</div>
                </header>
                <div class="response-body">
                    <div class="response-section">
                        <h3>Headers</h3>
                        <pre id="response-headers" class="response-pre">{}</pre>
                    </div>
                    <div class="response-section">
                        <div class="response-section__header">
                            <h3>Body</h3>
                            <div class="response-body__controls" role="group" aria-label="Response body view options">
                                <div class="response-body__views" role="group" aria-label="Format type">
                                    <button type="button" class="response-body__view-button is-active" data-response-body-view="json" aria-pressed="true">JSON</button>
                                    <button type="button" class="response-body__view-button" data-response-body-view="xml" aria-pressed="false">XML</button>
                                    <button type="button" class="response-body__view-button" data-response-body-view="html" aria-pressed="false">HTML</button>
                                </div>
                                <div class="response-body__modes" role="group" aria-label="Display mode">
                                    <button type="button" class="response-body__mode-button is-active" data-response-body-mode="pretty" aria-pressed="true">Pretty</button>
                                    <button type="button" class="response-body__mode-button" data-response-body-mode="preview" aria-pressed="false">Preview</button>
                                </div>
                            </div>
                        </div>
                        <div class="response-body__content">
                            <pre id="response-body-pretty" class="response-pre">{}</pre>
                            <iframe id="response-body-preview" class="response-preview" title="Response body preview" hidden></iframe>
                        </div>
                    </div>
                    <div class="response-section">
                        <h3>Assertions</h3>
                        <div id="response-assertions" class="assertions-list"></div>
                    </div>
                </div>
            </div>
        </section>
    </section>
</div>

<div class="modal" id="save-request-modal" hidden aria-hidden="true" tabindex="-1">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="save-request-modal-title">
        <div class="modal-header">
            <h3 id="save-request-modal-title">Save Request</h3>
        </div>
        <div class="modal-body">
            <label for="save-request-name">Request Name</label>
            <input type="text" id="save-request-name" class="form-control" autocomplete="off" />
        </div>
        <div class="modal-footer">
            <button type="button" id="save-request-cancel" class="btn btn-tertiary">Cancel</button>
            <button type="button" id="save-request-confirm" class="btn btn-primary">Save</button>
        </div>
    </div>
</div>
{% endblock %}

{% block body_js %}
{{ block.super }}
<script>
    window.require = {
        paths: {
            vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs',
        },
    };
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js" integrity="sha512-ZG31AN9z/CQD1YDDAK4RUAvogwbJHv6bHrumrnMLzdCrVu4HeAqrUX7Jsal/cbUwXGfaMUNmQU04tQ8XXl5Znw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    window.MonacoEnvironment = {
        getWorkerUrl: function () {
            const base = 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/';
            const script = `self.MonacoEnvironment={baseUrl:"${base}"};importScripts("${base}vs/base/worker/workerMain.js");`;
            return `data:text/javascript;charset=utf-8,${encodeURIComponent(script)}`;
        },
    };
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<script src="{% static 'js/api_tester.js' %}?v=20251016"></script>
{% endblock %}
