{% extends "base/base.html" %}
{% load static %}

{% block title %}Automation Reports{% endblock %}

{% block head_css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/automation.css' %}">
{% endblock %}

{% block content %}
<div class="automation-reports" id="automation-reports">
    <section class="automation-panel" aria-labelledby="headline-reports">
        <div class="panel-header">
            <h2 id="headline-reports">REPORTS</h2>
        </div>
        <div class="panel-body">
                <div class="reports-grid">
                    {# Embed testcase_reports as JSON for client-side detail lookups #}
                    {{ testcase_reports_serialized|json_script:"automation_testcase_reports" }}
                    <div id="reports-tabs" class="reports-tabs-wrapper">
                            <div class="reports-tabs-bar">
                            <div class="card-actions">
                                <div role="tablist" aria-label="Report tabs" class="report-tabs">
                                    <button role="tab" aria-selected="true" aria-controls="panel-automated" id="tab-automated" class="tab-btn">Automated Report</button>
                                    <button role="tab" aria-selected="false" aria-controls="panel-testcase" id="tab-testcase" class="tab-btn">Test Case Report</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="reports-tabs-panels">
                        <div id="panel-automated" role="tabpanel" aria-labelledby="tab-automated" class="report-panel" data-active="true">
                            <div class="card table-card automation-table-card">
                                <div class="panel-controls">
                                    <label class="inline-filter">Filter: <input type="text" id="automation-report-filter" placeholder="Report id or triggered in" /></label>
                                    <form class="inline-filter" method="get" action="{% url 'automation-reports-export' %}">
                                        <label class="inline-filter">From: <input type="date" name="start" value="{{ request.GET.start }}" /></label>
                                        <label class="inline-filter">To: <input type="date" name="end" value="{{ request.GET.end }}" /></label>
                                        <button type="submit" class="btn btn-primary">Export</button>
                                    </form>
                                </div>
                                <table class="table-modern automation-table" id="automation-report-table" aria-label="Automation reports">
                                    <thead>
                                        <tr>
                                            <th scope="col" class="col-collapse" aria-hidden="true"></th>
                                            <th scope="col">Report ID</th>
                                            <th scope="col">Triggered In</th>
                                            <th scope="col">Triggered By</th>
                                            <th scope="col">Passed</th>
                                            <th scope="col">Failed</th>
                                            <th scope="col">Blocked</th>
                                            <th scope="col">Started At</th>
                                            <th scope="col">Finished At</th>
                                        </tr>
                                    </thead>
                                    <tbody data-role="automation-report-list">
                                        {% for r in automation_reports %}
                                        <tr class="report-row" data-report-id="{{ r.id }}" aria-expanded="false" tabindex="0">
                                            <td class="col-collapse" aria-hidden="true">
                                                <button type="button" class="btn-icon" aria-controls="report-details-{{ r.id }}" aria-expanded="false">▸</button>
                                            </td>
                                            <td data-label="Report ID">
                                                <strong>{{ r.report_id }}</strong>
                                                <div class="table-secondary">{{ r.triggered_in }} — {{ r.triggered_by }}</div>
                                            </td>
                                            <td data-label="Triggered In">{{ r.triggered_in }}</td>
                                            <td data-label="Triggered By">{{ r.triggered_by }}</td>
                                            <td data-label="Passed">{{ r.total_passed }}</td>
                                            <td data-label="Failed">{{ r.total_failed }}</td>
                                            <td data-label="Blocked">{{ r.total_blocked }}</td>
                                            <td data-label="Started At">{{ r.started|default:"—" }}</td>
                                            <td data-label="Finished At">{{ r.finished|default:"—" }}</td>
                                        </tr>
                                        <tr class="report-details" id="report-details-{{ r.id }}" hidden>
                                            <td colspan="9">
                                                <div class="report-details-inner">
                                                    <h4 class="details-heading">Test Cases</h4>
                                                    <div class="table-responsive">
                                                        <table class="table-modern inner-testcase-table">
                                                            <thead>
                                                                <tr>
                                                                    <th>Testcase ID</th>
                                                                    <th>Request Name</th>
                                                                    <th>Run ID</th>
                                                                    <th>Outcome</th>
                                                                    <th>Started At</th>
                                                                    <th>Finished At</th>
                                                                    <th>Actions</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for t in r.testcases %}
                                                                    <tr data-testcase-id="{{ t.testcase_id }}" data-run-id="{{ t.run_id }}" data-automation-report-id="{{ r.id }}">
                                                                        <td>{{ t.testcase_id }}</td>
                                                                        <td>{{ t.request_name }}</td>
                                                                        <td>{{ t.run_id }}</td>
                                                                        <td>{{ t.outcome|default:"—" }}</td>
                                                                        <td>{{ t.started|default:"—" }}</td>
                                                                        <td>{{ t.finished|default:"—" }}</td>
                                                                        <td>
                                                                            <button class="btn btn-sm" data-action="view-testcase" data-testcase-id="{{ t.testcase_id }}">View</button>
                                                                        </td>
                                                                    </tr>
                                                                {% empty %}
                                                                    <tr><td colspan="7" class="empty">No test case available.</td></tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr><td colspan="9" class="empty">No automation reports found.</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="table-pagination" id="automation-report-pagination" aria-label="Automation report pagination"></div>
                        </div>

                        <div id="panel-testcase" role="tabpanel" aria-labelledby="tab-testcase" class="report-panel" data-active="false" hidden>
                            <div class="table-round">
                                <div class="panel-controls" style="margin:0.85rem 0 0.6rem 0;">
                                    <label class="inline-filter">Filter: <input type="text" id="testcase-report-filter" placeholder="Testcase id or request name" /></label>
                                </div>
                                <table class="table-modern automation-table" id="testcase-report-table" aria-label="Test case reports">
                                    <thead>
                                        <tr>
                                                    <th scope="col">Testcase ID</th>
                                                    <th scope="col">Request Name</th>
                                                    <th scope="col">Triggered By</th>
                                                    <th scope="col">Started At</th>
                                                    <th scope="col">Finished At</th>
                                                    <th scope="col">Action</th>
                                                </tr>
                                    </thead>
                                    <tbody data-role="testcase-report-list">
                                        {% for t in testcase_reports_serialized %}
                                        <tr data-testcase-id="{{ t.testcase_id }}" data-run-id="{{ t.run_id }}" data-automation-report-id="{{ t.automation_report_id }}">
                                            <td data-label="Testcase ID">
                                                <strong>{{ t.testcase_id }}</strong>
                                                <div class="table-secondary">{{ t.request_name }}</div>
                                            </td>
                                            <td data-label="Request Name">{{ t.request_name }}</td>
                                            <td data-label="Triggered By">{{ t.triggered_by|default:'' }}</td>
                                            <td data-label="Started At">{{ t.started|default:"—" }}</td>
                                            <td data-label="Finished At">{{ t.finished|default:"—" }}</td>
                                            <td data-label="Action">
                                                <div class="table-action-group">
                                                    <button class="btn btn-sm" data-action="view-testcase" data-testcase-id="{{ t.testcase_id }}" data-automation-report-id="{{ t.automation_report_id }}">View</button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr><td colspan="6" class="empty">No testcase reports found.</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="table-pagination" id="testcase-report-pagination" aria-label="Testcase report pagination"></div>
                        </div>
                    </div>
            </div>
        </div>
    </section>
    <!-- Testcase View Modal -->
    <div class="automation-modal" id="testcase-view-modal" hidden>
        <div class="automation-modal__backdrop" data-action="close-testcase-view"></div>
        <div class="automation-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="testcase-view-title">
            <header class="automation-modal__header">
                <h2 id="testcase-view-title">Testcase Details</h2>
                <button type="button" class="automation-modal__close" data-action="close-testcase-view" aria-label="Close">&times;</button>
            </header>
            <div class="automation-modal__body" style="padding:1rem;">
                <div class="api-tester__response-card" aria-live="polite">
                    <header>
                        <div id="tc-response-summary" class="response-summary">No request executed yet.</div>
                    </header>
                    <div class="response-body">
                        <div class="response-section">
                            <h3>Headers</h3>
                            <pre id="tc-response-headers" class="response-pre">{}</pre>
                        </div>
                        <div class="response-section">
                            <div class="response-section__header">
                                <h3>Body</h3>
                                <div class="response-body__controls" role="group" aria-label="Response body view options">
                                    <div class="response-body__views" role="group" aria-label="Format type">
                                        <button type="button" class="response-body__view-button is-active" data-response-body-view="json" aria-pressed="true">JSON</button>
                                        <button type="button" class="response-body__view-button" data-response-body-view="xml" aria-pressed="false">XML</button>
                                        <button type="button" class="response-body__view-button" data-response-body-view="html" aria-pressed="false">HTML</button>
                                    </div>
                                    <div class="response-body__modes" role="group" aria-label="Display mode">
                                        <button type="button" class="response-body__mode-button is-active" data-response-body-mode="pretty" aria-pressed="true">Pretty</button>
                                        <button type="button" class="response-body__mode-button" data-response-body-mode="preview" aria-pressed="false">Preview</button>
                                    </div>
                                </div>
                            </div>
                            <div class="response-body__content">
                                <pre id="tc-response-body-pretty" class="response-pre">{}</pre>
                                <iframe id="tc-response-body-preview" class="response-preview" title="Response body preview" hidden></iframe>
                            </div>
                        </div>
                        <div class="response-section">
                            <h3>Assertions</h3>
                            <div id="tc-response-assertions" class="assertions-list"></div>
                            <div class="script-console" aria-live="polite">
                                <div class="script-console__header">Pre-request Console</div>
                                <div class="script-console__body" id="tc-pre-script-console-response" role="log" aria-live="polite" aria-label="Pre-request script console output">Console idle.</div>
                            </div>
                            <div class="script-console" aria-live="polite">
                                <div class="script-console__header">Post-request Console</div>
                                <div class="script-console__body" id="tc-post-script-console-response" role="log" aria-live="polite" aria-label="Post-request script console output">Console idle.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_js %}
    {{ block.super }}
    <script>
        (function () {
            // Tab switching for Reports card
            function $(sel, ctx){ return (ctx||document).querySelector(sel); }
            function $all(sel, ctx){ return Array.from((ctx||document).querySelectorAll(sel)); }
            var tabAutomated = $('#tab-automated');
            var tabTestcase = $('#tab-testcase');
            var panelAutomated = $('#panel-automated');
            var panelTestcase = $('#panel-testcase');

            function activateTab(tabBtn, panel) {
                // deactivate all
                $all('[role="tab"]').forEach(function(b){ b.setAttribute('aria-selected','false'); });
                $all('[role="tabpanel"]').forEach(function(p){ p.setAttribute('hidden',''); p.dataset.active = 'false'; });
                // activate
                tabBtn.setAttribute('aria-selected','true');
                panel.removeAttribute('hidden');
                panel.dataset.active = 'true';
            }

            // When switching tabs, refresh pagers and inner pagers so controls render consistently
            function refreshPagersForPanel(panel) {
                try {
                    if (automationPager && typeof automationPager.refresh === 'function') automationPager.refresh();
                } catch (e) { /* ignore */ }
                try {
                    if (testcasePager && typeof testcasePager.refresh === 'function') testcasePager.refresh();
                } catch (e) { /* ignore */ }
                try {
                    // innerPagers collected during initialization
                    if (window.__innerTestcasePagers && Array.isArray(window.__innerTestcasePagers)) {
                        window.__innerTestcasePagers.forEach(function(p){ try { if (p && typeof p.refresh === 'function') p.refresh(); } catch (e) {} });
                    }
                } catch (e) { /* ignore */ }
            }

            if (tabAutomated && tabTestcase && panelAutomated && panelTestcase) {
                tabAutomated.addEventListener('click', function(){ activateTab(tabAutomated, panelAutomated); refreshPagersForPanel(panelAutomated); });
                tabTestcase.addEventListener('click', function(){ activateTab(tabTestcase, panelTestcase); refreshPagersForPanel(panelTestcase); });
            }

            // Filters for each table (simple client-side text match)
            function wireFilter(inputId, tableId, columnsToCheck) {
                var input = document.getElementById(inputId);
                var table = document.getElementById(tableId);
                if (!input || !table) return;
                var tbody = table.querySelector('tbody');
                input.addEventListener('input', function () {
                    var q = (this.value || '').toLowerCase().trim();
                    // For automation report table, only filter primary report rows (exclude .report-details)
                    var selector = (tableId === 'automation-report-table') ? 'tr.report-row' : 'tr';
                    Array.from(tbody.querySelectorAll(selector)).forEach(function (tr) {
                        try {
                            var text = columnsToCheck.map(function(i){ return (tr.children[i] && tr.children[i].textContent||'').toLowerCase(); }).join(' ');
                            var show = (!q || text.indexOf(q) !== -1);
                            tr.style.display = show ? '' : 'none';
                            // if this is a primary report row, also toggle its details row visibility
                            if (tr.classList.contains('report-row')) {
                                var id = tr.dataset.reportId;
                                var details = tbody.querySelector('#report-details-' + id);
                                if (details) {
                                    // keep details visible only when parent visible and expanded
                                    var expanded = tr.getAttribute('aria-expanded') === 'true';
                                    if (show && expanded) {
                                        details.removeAttribute('hidden');
                                    } else {
                                        details.setAttribute('hidden','');
                                    }
                                }
                            }
                        } catch (e) { /* ignore per-row errors */ }
                    });
                });
            }

            // automation reports: check report id and triggered in (account for collapse column)
            wireFilter('automation-report-filter','automation-report-table',[1,2]);
            // testcase reports: check testcase id and request name (first two columns)
            wireFilter('testcase-report-filter','testcase-report-table',[0,1]);

            // --- Pagination ---
            function createPaginationControls(paginationId, onPrev, onNext, defaultPageSize) {
                var container = document.getElementById(paginationId);
                if (!container) return;
                container.innerHTML = '';
                var prev = document.createElement('button');
                prev.type = 'button'; prev.className = 'btn btn-sm'; prev.textContent = 'Prev';
                var info = document.createElement('span'); info.className = 'pagination-info'; info.style.margin = '0 0.6rem';
                var next = document.createElement('button'); next.type = 'button'; next.className = 'btn btn-sm'; next.textContent = 'Next';
                prev.addEventListener('click', onPrev); next.addEventListener('click', onNext);

                // pagesize selector
                var select = document.createElement('select'); select.className = 'pagination-pagesize';
                [10,20,30,40,50,100].forEach(function(n){ var opt = document.createElement('option'); opt.value = n; opt.text = String(n); select.appendChild(opt); });
                if (defaultPageSize) select.value = String(defaultPageSize);
                select.style.marginLeft = '0.6rem'; select.style.padding = '0.25rem 0.5rem'; select.title = 'Rows per page';

                container.appendChild(prev); container.appendChild(info); container.appendChild(next); container.appendChild(select);
                return { prev: prev, info: info, next: next, pagesize: select };
            }

            function initTablePagination(tableId, paginationId, pageSize) {
                var table = document.getElementById(tableId);
                var tbody = table && table.querySelector('tbody');
                if (!tbody) return;
                // Only paginate primary rows (exclude details rows used by accordions)
                // Select only primary rows for pagination. For the automation table we want only .report-row entries.
                var rows;
                if (tableId === 'automation-report-table') {
                    rows = Array.from(tbody.querySelectorAll('tr.report-row'));
                } else {
                    rows = Array.from(tbody.querySelectorAll('tr')).filter(function(r){ return !r.classList.contains('report-details') && !r.classList.contains('empty'); });
                }
                var state = { page: 1, pageSize: pageSize, rows: rows };

                function renderPage() {
                    var start = (state.page - 1) * state.pageSize;
                    var end = start + state.pageSize;
                    state.rows.forEach(function (r, i) {
                        var show = (i >= start && i < end);
                        r.style.display = show ? '' : 'none';
                        // if this is a report-row, ensure its details row follows same visibility (unless expanded)
                        if (r.classList.contains('report-row')) {
                            var id = r.dataset.reportId;
                            var details = tbody.querySelector('#report-details-' + id);
                            if (details) {
                                var expanded = r.getAttribute('aria-expanded') === 'true';
                                if (show && expanded) {
                                    details.removeAttribute('hidden');
                                } else {
                                    details.setAttribute('hidden','');
                                }
                            }
                        }
                    });
                    var totalPages = Math.max(1, Math.ceil(state.rows.length / state.pageSize));
                    controls.info.textContent = state.page + ' / ' + totalPages;
                    controls.prev.disabled = (state.page <= 1);
                    controls.next.disabled = (state.page >= totalPages);
                }

                function prev() { if (state.page > 1) { state.page--; renderPage(); } }
                function next() { var totalPages = Math.max(1, Math.ceil(state.rows.length / state.pageSize)); if (state.page < totalPages) { state.page++; renderPage(); } }

                var controls = createPaginationControls(paginationId, prev, next, pageSize) || { prev: { disabled: true }, next: { disabled: true }, info: { textContent: '' }, pagesize: null };
                // wire pagesize change
                if (controls.pagesize) {
                    controls.pagesize.addEventListener('change', function () {
                        var v = parseInt(this.value, 10) || 10;
                        state.pageSize = v; state.page = 1; renderPage();
                    });
                }
                renderPage();

                // expose a refresher to update rows (used after filtering)
                return {
                    refresh: function () {
                        // Only include rows that are currently visible according to filter (style.display !== 'none')
                        if (tableId === 'automation-report-table') {
                            state.rows = Array.from(tbody.querySelectorAll('tr.report-row')).filter(function(r){ return ((r.style.display || '') !== 'none'); });
                        } else {
                            state.rows = Array.from(tbody.querySelectorAll('tr')).filter(function(r){ return !r.classList.contains('report-details') && !r.classList.contains('empty') && ((r.style.display || '') !== 'none'); });
                        }
                        state.page = 1; renderPage();
                    }
                };
            }

            // Initialize paginations for both tables with 10 rows per page
            var automationPager = initTablePagination('automation-report-table','automation-report-pagination',10);
            var testcasePager = initTablePagination('testcase-report-table','testcase-report-pagination',10);

            // Initialize pagination for each nested inner-testcase-table (10 rows per page)
            function initInnerTablePagination(tableEl, pageSize) {
                if (!tableEl) return null;
                var tbody = tableEl.querySelector('tbody');
                if (!tbody) return null;

                // collect only real testcase rows (ignore placeholder empty rows)
                var rows = Array.from(tbody.querySelectorAll('tr')).filter(function (r) { return !r.classList.contains('empty'); });

                // create pagination container immediately after the table
                var container = document.createElement('div');
                container.className = 'table-pagination inner-pagination';
                tableEl.parentNode.insertBefore(container, tableEl.nextSibling);

                var prev = document.createElement('button'); prev.type = 'button'; prev.className = 'btn btn-sm'; prev.textContent = 'Prev';
                var info = document.createElement('span'); info.className = 'pagination-info'; info.style.margin = '0 0.6rem';
                var next = document.createElement('button'); next.type = 'button'; next.className = 'btn btn-sm'; next.textContent = 'Next';

                // pagesize select for inner tables
                var select = document.createElement('select'); select.className = 'pagination-pagesize';
                [10,20,30,40,50,100].forEach(function(n){ var opt = document.createElement('option'); opt.value = n; opt.text = String(n); select.appendChild(opt); });
                select.value = String(pageSize);
                select.style.marginLeft = '0.6rem'; select.style.padding = '0.25rem 0.5rem'; select.title = 'Rows per page';

                container.appendChild(prev); container.appendChild(info); container.appendChild(next); container.appendChild(select);

                var state = { page: 1, pageSize: pageSize, rows: rows };

                function render() {
                    var start = (state.page - 1) * state.pageSize;
                    var end = start + state.pageSize;
                    state.rows.forEach(function (r, i) {
                        r.style.display = (i >= start && i < end) ? '' : 'none';
                    });
                    var totalPages = Math.max(1, Math.ceil(state.rows.length / state.pageSize));
                    info.textContent = state.page + ' / ' + totalPages;
                    prev.disabled = (state.page <= 1);
                    next.disabled = (state.page >= totalPages);
                }

                prev.addEventListener('click', function () { if (state.page > 1) { state.page--; render(); } });
                next.addEventListener('click', function () { var totalPages = Math.max(1, Math.ceil(state.rows.length / state.pageSize)); if (state.page < totalPages) { state.page++; render(); } });
                // pagesize change for inner tables
                select.addEventListener('change', function () { state.pageSize = parseInt(this.value,10) || 10; state.page = 1; render(); });

                // expose a refresh method in case rows change (e.g., filtered)
                return {
                    refresh: function () {
                        state.rows = Array.from(tbody.querySelectorAll('tr')).filter(function (r) { return !r.classList.contains('empty') && ((r.style.display || '') !== 'none'); });
                        state.page = 1; render();
                    }
                };
            }

            // wire up all inner testcase tables found on the page
            // Keep track of inner table pagers so we can refresh them when tabs change
            window.__innerTestcasePagers = [];
            Array.from(document.querySelectorAll('.inner-testcase-table')).forEach(function (tbl) {
                try { var p = initInnerTablePagination(tbl, 10); if (p) window.__innerTestcasePagers.push(p); } catch (e) { /* ignore */ }
            });

            // --- Accordion toggles for automation report rows ---
                (function () {
                var table = document.getElementById('automation-report-table');
                if (!table) return;
                var tbody = table.querySelector('tbody');

                // click on the toggle button to expand/collapse
                tbody.addEventListener('click', function (ev) {
                    // If the click was on an action button or inside action controls, ignore (we have separate handlers)
                    if (ev.target.closest('button[data-action]') || ev.target.closest('a')) return;

                    // If click was on the small icon button, handle that first
                    var btn = ev.target.closest('.btn-icon[aria-controls^="report-details-"]');
                    if (btn) {
                        toggleReportRow(btn);
                        return;
                    }

                    // Otherwise, if the click occurred on the primary report row (not its details), toggle the accordion
                    var row = ev.target.closest('tr.report-row');
                    if (row && !ev.target.closest('button') && !ev.target.closest('.table-action-group')) {
                        var icon = row.querySelector('.btn-icon[aria-controls^="report-details-"]');
                        if (icon) toggleReportRow(icon);
                    }
                });

                // support keyboard expand/collapse on Enter/Space when focusing primary row
                tbody.addEventListener('keydown', function (ev) {
                    var tr = ev.target.closest('tr.report-row');
                    if (!tr) return;
                    if (ev.key === 'Enter' || ev.key === ' ') {
                        ev.preventDefault();
                        var btn = tr.querySelector('.btn-icon[aria-controls^="report-details-"]');
                        if (btn) toggleReportRow(btn);
                    }
                });

                function toggleReportRow(btn) {
                    var row = btn.closest('tr.report-row');
                    if (!row) return;
                    var id = row.dataset.reportId;
                    var details = tbody.querySelector('#report-details-' + id);
                    if (!details) return;
                    var expanded = row.getAttribute('aria-expanded') === 'true';
                    row.setAttribute('aria-expanded', expanded ? 'false' : 'true');
                    btn.setAttribute('aria-expanded', expanded ? 'false' : 'true');
                    btn.textContent = expanded ? '▸' : '▾';
                    if (!expanded && row.style.display !== 'none') {
                        details.removeAttribute('hidden');
                    } else {
                        details.setAttribute('hidden','');
                    }
                }
            })();

            // Update pagination when filters run (wrap wireFilter's input handler already present)
            // We'll patch the filter inputs to also reset paginator page to 1 and re-render
            function hookFilterToPager(inputId, pager) {
                var input = document.getElementById(inputId);
                if (!input || !pager) return;
                input.addEventListener('input', function () { if (pager && pager.refresh) pager.refresh(); });
            }
            hookFilterToPager('automation-report-filter', automationPager);
            hookFilterToPager('testcase-report-filter', testcasePager);

            // View testcase details (open modal)
            (function () {
                var root = document.getElementById('automation-reports');
                if (!root) return;
                var modal = document.getElementById('testcase-view-modal');
                // modal content will be referenced by id-prefixed elements inside the dialog

                // Helper to fetch testcase detail from the server (fallback to embedded JSON if available)
                function fetchTestcaseDetail(reportId, testcaseId) {
                    var url = '/api/core/automation-report/' + encodeURIComponent(reportId) + '/testcase/' + encodeURIComponent(testcaseId) + '/';
                    return fetch(url, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } })
                        .then(function (resp) {
                            if (!resp.ok) throw resp;
                            return resp.json();
                        })
                        .catch(function () {
                            // fallback: try embedded JSON
                            try {
                                var el = document.getElementById('automation_testcase_reports');
                                if (el) {
                                    var arr = JSON.parse(el.textContent || el.innerText || '[]');
                                    return Promise.resolve(arr.find(function (r) {
                                        return String(r.automation_report_id) === String(reportId) && String(r.testcase_id) === String(testcaseId);
                                    }) || null);
                                }
                            } catch (e) { /* ignore */ }
                            return Promise.resolve(null);
                        });
                }

                // Modal focus management helpers
                var lastTrigger = null;
                function trapFocus(modalEl) {
                    if (!modalEl) return function () {};
                    var focusableSelectors = 'a[href], area[href], input:not([disabled]):not([type=hidden]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), [tabindex]:not([tabindex="-1"])';
                    var nodes = Array.from(modalEl.querySelectorAll(focusableSelectors)).filter(function (n) { return n.offsetWidth || n.offsetHeight || n.getClientRects().length; });
                    var first = nodes[0] || modalEl;
                    var last = nodes[nodes.length - 1] || modalEl;
                    function keyHandler(e) {
                        if (e.key === 'Tab') {
                            if (nodes.length === 0) {
                                e.preventDefault();
                                return;
                            }
                            if (e.shiftKey) {
                                if (document.activeElement === first) {
                                    e.preventDefault();
                                    last.focus();
                                }
                            } else {
                                if (document.activeElement === last) {
                                    e.preventDefault();
                                    first.focus();
                                }
                            }
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            closeModal();
                        }
                    }
                    document.addEventListener('keydown', keyHandler);
                    // return a cleanup function
                    return function () { document.removeEventListener('keydown', keyHandler); };
                }

                function openModal(data, triggerElement) {
                    if (!modal) return;
                    lastTrigger = triggerElement || null;
                    // populate summary with basic testcase metadata
                    var summaryEl = modal.querySelector('#tc-response-summary');
                    if (summaryEl) {
                        var parts = [];
                        if (data.testcase_id) parts.push('ID: ' + data.testcase_id);
                        if (data.request_name) parts.push(data.request_name);
                        if (data.run_id) parts.push('Run: ' + data.run_id);
                        if (data.outcome) parts.push('Outcome: ' + data.outcome);
                        if (data.started) parts.push('Started: ' + data.started);
                        if (data.finished) parts.push('Finished: ' + data.finished);
                        summaryEl.textContent = parts.join(' — ') || 'Testcase details';
                    }

                    // populate headers
                    var headersEl = modal.querySelector('#tc-response-headers');
                    try {
                        if (headersEl) headersEl.textContent = data.response_headers ? JSON.stringify(data.response_headers, null, 2) : '{}';
                    } catch (e) { if (headersEl) headersEl.textContent = '{}'; }

                    // populate body (pretty) and preview iframe
                    var bodyPretty = modal.querySelector('#tc-response-body-pretty');
                    var bodyPreview = modal.querySelector('#tc-response-body-preview');
                    var bodyText = data.response_body || '';

                    // helpers for formatting
                    function escapeHtml(str) {
                        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                    }

                    function prettyPrintJSON(txt) {
                        try {
                            var obj = JSON.parse(txt);
                            return JSON.stringify(obj, null, 2);
                        } catch (e) {
                            return txt; // return raw if not valid JSON
                        }
                    }

                    function prettyPrintXML(txt) {
                        try {
                            var formatted = txt.replace(/>\s*</g, '><').replace(/>\s+</g,'><');
                            // insert line breaks between tags
                            formatted = formatted.replace(/></g, '>\n<');
                            var pad = 0;
                            var lines = formatted.split('\n');
                            for (var i = 0; i < lines.length; i++) {
                                var line = lines[i].trim();
                                if (line.match(/^<\/?[\w]/) && !line.match(/^<\?/) ) {
                                    if (line.match(/^<\//)) {
                                        pad = Math.max(pad-1,0);
                                    }
                                    lines[i] = '  '.repeat(pad) + line;
                                    if (line.match(/^<[^\/!].*[^\/]>/) && !line.match(/^<.*\/>$/) && !line.match(/^<\?/)) {
                                        pad++;
                                    }
                                } else {
                                    lines[i] = '  '.repeat(pad) + line;
                                }
                            }
                            return lines.join('\n');
                        } catch (e) { return txt; }
                    }

                    function applyBodyFormatting() {
                        var activeView = modal.querySelector('.response-body__view-button.is-active');
                        var activeMode = modal.querySelector('.response-body__mode-button.is-active');
                        var view = activeView ? activeView.getAttribute('data-response-body-view') : 'json';
                        var mode = activeMode ? activeMode.getAttribute('data-response-body-mode') : 'pretty';

                        if (!bodyPretty || !bodyPreview) return;

                        if (mode === 'preview') {
                            // show iframe preview for all formats
                            bodyPretty.hidden = true;
                            try { bodyPreview.srcdoc = bodyText || ''; bodyPreview.hidden = false; } catch (e) { bodyPreview.hidden = true; }
                            return;
                        }

                        // pretty mode -> render into pre
                        bodyPreview.hidden = true;
                        bodyPretty.hidden = false;

                        if (view === 'json') {
                            bodyPretty.textContent = prettyPrintJSON(bodyText || '');
                        } else if (view === 'xml') {
                            bodyPretty.textContent = prettyPrintXML(bodyText || '');
                        } else if (view === 'html') {
                            // for HTML in pretty mode, show escaped HTML source
                            bodyPretty.textContent = escapeHtml(bodyText || '');
                        } else {
                            bodyPretty.textContent = bodyText || '';
                        }
                    }

                    // initial formatting
                    if (bodyPretty) bodyPretty.textContent = '';
                    if (bodyPreview) { try { bodyPreview.srcdoc = ''; bodyPreview.hidden = true; } catch (e) { bodyPreview.hidden = true; } }
                    applyBodyFormatting();

                    // populate assertions
                    var assertionsEl = modal.querySelector('#tc-response-assertions');
                    if (assertionsEl) {
                        assertionsEl.innerHTML = '';
                        try {
                            var passed = data.assertions_passed || [];
                            var failed = data.assertions_failed || [];
                            if (!passed.length && !failed.length) {
                                assertionsEl.textContent = 'No assertions recorded.';
                            } else {
                                passed.forEach(function (a) {
                                    var el = document.createElement('div'); el.className = 'assertion assertion--passed'; el.textContent = 'PASS: ' + String(a);
                                    assertionsEl.appendChild(el);
                                });
                                failed.forEach(function (a) {
                                    var el = document.createElement('div'); el.className = 'assertion assertion--failed'; el.textContent = 'FAIL: ' + String(a);
                                    assertionsEl.appendChild(el);
                                });
                            }
                        } catch (e) { assertionsEl.textContent = 'No assertions recorded.'; }
                    }

                    // populate consoles
                    var preConsole = modal.querySelector('#tc-pre-script-console-response');
                    var postConsole = modal.querySelector('#tc-post-script-console-response');
                    if (preConsole) preConsole.textContent = (data.pre_console || 'Console idle.');
                    if (postConsole) postConsole.textContent = (data.post_console || 'Console idle.');

                    // wire simple body view/mode toggles once
                    if (!modal._wiredBodyControls) {
                        modal._wiredBodyControls = true;
                        modal.addEventListener('click', function (ev) {
                            var vBtn = ev.target.closest('.response-body__view-button');
                            if (vBtn) {
                                var group = vBtn.parentNode;
                                Array.from(group.querySelectorAll('.response-body__view-button')).forEach(function (b) { b.classList.remove('is-active'); b.setAttribute('aria-pressed', 'false'); });
                                vBtn.classList.add('is-active'); vBtn.setAttribute('aria-pressed', 'true');
                                // re-apply formatting after view change
                                applyBodyFormatting();
                                return;
                            }
                            var mBtn = ev.target.closest('.response-body__mode-button');
                            if (mBtn) {
                                var mGroup = mBtn.parentNode;
                                Array.from(mGroup.querySelectorAll('.response-body__mode-button')).forEach(function (b) { b.classList.remove('is-active'); b.setAttribute('aria-pressed', 'false'); });
                                mBtn.classList.add('is-active'); mBtn.setAttribute('aria-pressed', 'true');
                                // re-apply formatting after mode change
                                applyBodyFormatting();
                                return;
                            }
                        });
                    }

                    modal.removeAttribute('hidden');
                    document.body.classList.add('modal-open');
                    // focus the close button (or dialog) and trap focus
                    var cleanup = trapFocus(modal.querySelector('.automation-modal__dialog'));
                    modal._focusCleanup = cleanup;
                    var closeBtn = modal.querySelector('.automation-modal__close[data-action="close-testcase-view"]');
                    if (closeBtn && typeof closeBtn.focus === 'function') closeBtn.focus();
                }

                function closeModal() {
                    if (!modal) return;
                    modal.setAttribute('hidden','');
                    document.body.classList.remove('modal-open');
                    try {
                        if (modal._focusCleanup) {
                            modal._focusCleanup();
                            modal._focusCleanup = null;
                        }
                    } catch (e) {}
                    // restore focus to triggering element
                    try { if (lastTrigger && typeof lastTrigger.focus === 'function') lastTrigger.focus(); } catch (e) {}
                    lastTrigger = null;
                }

                // Click handler: view buttons inside report details
                root.addEventListener('click', function (ev) {
                    var btn = ev.target.closest('button[data-action="view-testcase"]');
                    if (!btn) return;
                    var tr = btn.closest('tr');
                    if (!tr) return;
                    var testcaseId = tr.dataset.testcaseId || tr.getAttribute('data-testcase-id') || (tr.children[0] && tr.children[0].textContent && tr.children[0].textContent.trim());
                    var runId = tr.dataset.runId || tr.getAttribute('data-run-id') || (tr.children[2] && tr.children[2].textContent && tr.children[2].textContent.trim());
                    var reportId = tr.dataset.automationReportId || tr.getAttribute('data-automation-report-id') || (tr.closest('tr.report-row') && tr.closest('tr.report-row').dataset.reportId);
                    var baseData = {
                        testcase_id: testcaseId,
                        request_name: tr.children[1] && (tr.children[1].textContent || tr.children[1].innerText) || '',
                        run_id: runId,
                        outcome: tr.children[3] && tr.children[3].textContent || '',
                        started: tr.children[4] && tr.children[4].textContent || '',
                        finished: tr.children[5] && tr.children[5].textContent || '',
                    };
                    // fetch richer payload from server, fallback to embedded JSON
                    fetchTestcaseDetail(reportId, testcaseId).then(function (found) {
                        if (found) {
                            baseData.response_body = found.response_body;
                            baseData.response_headers = found.response_headers;
                            baseData.error = found.error;
                            baseData.assertions_passed = found.assertions_passed;
                            baseData.assertions_failed = found.assertions_failed;
                        }
                        openModal(baseData, btn);
                    }).catch(function () { openModal(baseData, btn); });
                });

                // close handlers (backdrop and close buttons)
                root.addEventListener('click', function (ev) {
                    if (ev.target.closest('[data-action="close-testcase-view"]')) {
                        closeModal();
                    }
                    if (ev.target.classList.contains('automation-modal__backdrop')) {
                        closeModal();
                    }
                });
            })();
        })();

        (function () {
            try {
                const filterInput = document.getElementById('automation-report-filter');
                if (!filterInput) return;
                const table = document.getElementById('automation-report-table');
                const tbody = table && table.querySelector('tbody');
                filterInput.addEventListener('input', function () {
                    const q = (this.value || '').toLowerCase().trim();
                    if (!tbody) return;
                    Array.from(tbody.querySelectorAll('tr.report-row')).forEach(function (tr) {
                        try {
                            // account for collapse column at index 0
                            const id = (tr.children[1] && tr.children[1].textContent || '').toLowerCase();
                            const triggeredIn = (tr.children[2] && tr.children[2].textContent || '').toLowerCase();
                            tr.style.display = (!q || id.indexOf(q) !== -1 || triggeredIn.indexOf(q) !== -1) ? '' : 'none';
                            // hide/show details row as well
                            const details = tbody.querySelector('#report-details-' + tr.dataset.reportId);
                            if (details) {
                                const expanded = tr.getAttribute('aria-expanded') === 'true';
                                if (tr.style.display !== 'none' && expanded) {
                                    details.removeAttribute('hidden');
                                } else {
                                    details.setAttribute('hidden','');
                                }
                            }
                        } catch (e) { /* ignore per-row errors */ }
                    });
                });
            } catch (e) { /* ignore */ }
        })();
    </script>
{% endblock %}
