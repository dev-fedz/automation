{% extends "base/base.html" %}
{% load static %}

{% block title %}Automation · Data Management{% endblock %}

{% block head_css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/automation.css' %}">
{% endblock %}

{% block content %}
<div class="automation-dashboard" id="data-management-app" data-current-user-id="{% if request.user.is_authenticated %}{{ request.user.id }}{% else %}null{% endif %}">
    {% if perms.accounts.can_view_project_module %}<span id="perm-can-view-project-module" hidden></span>{% endif %}
    {% if perms.accounts.can_change_project_module %}<span id="perm-can-change-project-module" hidden></span>{% endif %}
    {% if perms.accounts.can_delete_project_module %}<span id="perm-can-delete-project-module" hidden></span>{% endif %}
    {% if perms.accounts.can_create_project_scenario %}<span id="perm-can-create-project-scenario" hidden></span>{% endif %}
    {% if perms.accounts.can_view_project_scenario %}<span id="perm-can-view-project-scenario" hidden></span>{% endif %}
    {% if perms.accounts.can_change_project_scenario %}<span id="perm-can-change-project-scenario" hidden></span>{% endif %}
    {% if perms.accounts.can_delete_project_scenario %}<span id="perm-can-delete-project-scenario" hidden></span>{% endif %}
    <div class="automation-grid data-management-grid">
        <section class="automation-panel data-card" data-entity="test-modules" data-section="test-modules" aria-labelledby="headline-test-modules" id="section-test-modules">
            <div class="panel-header">
                <div>
                    <h3 id="headline-test-modules">Test Modules</h3>
                    <p class="panel-subtitle">Register modules under test to organise test plans and cases.</p>
                </div>
                <div class="panel-actions">
                    <input type="search" class="automation-search" placeholder="Search modules" data-role="test-modules-search" aria-label="Search modules">
                    <select id="test-modules-filter-project" class="inline-select" aria-label="Filter by project">
                        <option value="">All projects</option>
                    </select>
                    {% if perms.accounts.can_create_project_module %}
                    <button type="button" class="btn-primary" data-action="open-test-modules-modal">New Module</button>
                    {% endif %}
                </div>
            </div>
            <div class="card table-card automation-table-card" aria-live="polite">
                <table class="table-modern automation-table" aria-label="Test modules register">
                    <thead>
                        <tr>
                            <th scope="col" class="col-collapse" aria-hidden="true"></th>
                            <th scope="col">Title</th>
                            <th scope="col">Description</th>
                            <th scope="col">Project</th>
                            <th scope="col">Created</th>
                            <th scope="col">Updated</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody data-role="test-modules-list">
                        {% if initial_test_modules %}
                            {% for module in initial_test_modules %}
                                <tr class="module-row" data-module-id="{{ module.id }}">
                                    <td class="col-collapse">
                                        <button type="button" class="btn-icon module-toggle" aria-expanded="false" data-action="toggle-module" data-module-id="{{ module.id }}" aria-label="Toggle scenarios for {{ module.title|default:''|escape }}">▸</button>
                                    </td>
                                    <td data-label="Title">{{ module.title|default:"" }}</td>
                                    <td data-label="Description">{{ module.description|default:"" }}</td>
                                    <td data-label="Project">
                                        {% if module.project_id %}Project {{ module.project_id }}{% else %}&mdash;{% endif %}
                                    </td>
                                    <td data-label="Created">{{ module.created_at|default:"—" }}</td>
                                    <td data-label="Updated">{{ module.updated_at|default:"—" }}</td>
                                    <td data-label="Actions">
                                        <div class="table-action-group">
                                            <button type="button" class="action-button" data-action="view-test-module" data-module-id="{{ module.id }}">View</button>
                                            <button type="button" class="action-button" data-action="edit-test-module" data-module-id="{{ module.id }}">Edit</button>
                                            <button type="button" class="action-button" data-action="delete-test-module" data-module-id="{{ module.id }}" data-variant="danger">Delete</button>
                                            
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="7" class="empty">No test modules registered yet. Add one to the registry.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    {% include "automation/modules/test_modules_modal.html" %}
    {% include "automation/modules/module_add_scenario_modal.html" %}


    {{ initial_metrics|default:"[]"|json_script:"data-management-initial-metrics" }}
    {{ api_endpoints|default:"{}"|json_script:"automation-api-endpoints" }}
    {{ initial_plans|default:"[]"|json_script:"automation-initial-plans" }}
    {{ initial_section|default:""|json_script:"data-management-initial-section" }}

</div>
{% endblock %}

{% block body_js %}
    {{ block.super }}
    <script src="{% static 'tinymce/tinymce.min.js' %}"></script>
    <script src="{% static 'js/data_management.js' %}"></script>
{% endblock %}
