{% extends 'base/base.html' %}
{% load static %}
{% block title %}Roles - List{% endblock %}

{% block head_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/automation.css' %}">
{% endblock %}

{% block content %}
<div class="automation-dashboard role-management-dashboard" id="roles-app">
  <section class="automation-panel role-management-panel" data-panel="roles" aria-labelledby="roles-heading">
    <div class="panel-header">
      <div>
        <h2 id="roles-heading">Roles</h2>
        <p class="panel-subtitle">Assign modules and fine-grained permissions for every workspace role.</p>
      </div>
      <div class="panel-actions">
        
        {% if perms.accounts.can_add_group %}
        <a class="btn-primary" href="/roles/create/" data-testid="role-create-link">Create Role</a>
        {% endif %}
      </div>
    </div>

    <div class="card table-card automation-table-card" data-testid="roles-card" aria-live="polite">
      <table class="table-modern automation-table" data-testid="roles-table" aria-label="Roles overview" id="roles-table">
        <thead>
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Name</th>
            <th scope="col">Modules</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for role in roles %}
          <tr data-role-id="{{ role.id }}">
            <td data-label="ID">{{ role.id }}</td>
            <td data-label="Name">
              <strong><a class="row-link" href="/roles/{{ role.id }}/" data-testid="role-name-{{ role.id }}">{{ role.name }}</a></strong>
            </td>
            <td data-label="Modules" class="modules-cell">
              {% with mods=role.modules.all %}
                {% if mods|length %}
                  <div class="table-scope-preview">
                    {% for m in mods %}
                      <span class="scope-chip">{{ m.name }}</span>
                    {% endfor %}
                  </div>
                {% else %}
                  <span class="muted">None</span>
                {% endif %}
              {% endwith %}
            </td>
            <td data-label="Actions">
              <div class="table-action-group">
                {% if perms.accounts.can_view_group %}
                <button type="button" class="action-button" data-role-view="{{ role.id }}" data-testid="role-view-{{ role.id }}">View</button>
                {% endif %}
                {% if perms.accounts.can_change_group %}
                <a class="action-button" href="/roles/{{ role.id }}/edit/" data-testid="role-edit-{{ role.id }}">Edit</a>
                {% endif %}
                {% if perms.accounts.can_delete_group %}
                <button type="button" class="action-button" data-variant="danger" data-role-delete="{{ role.id }}" data-testid="role-delete-{{ role.id }}">Delete</button>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr class="empty-row"><td colspan="4" class="empty" data-testid="roles-empty">No roles found</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="table-pagination" id="roles-pagination" aria-label="Roles pagination"></div>
  </section>

  <div class="automation-modal" data-role="role-modal" hidden>
    <div class="automation-modal__backdrop" data-action="close-role-modal"></div>
    <div class="automation-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="role-modal-title">
      <header class="automation-modal__header">
        <h2 id="role-modal-title" data-role="role-modal-title">Role</h2>
        <button type="button" class="automation-modal__close" data-action="close-role-modal" aria-label="Close role dialog">&times;</button>
      </header>
      <div class="automation-modal__body" data-role="role-modal-body"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block body_js %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const modal = document.querySelector('[data-role="role-modal"]');
      if(!modal){ return; }
      const modalBody = modal.querySelector('[data-role="role-modal-body"]');
      const modalTitle = modal.querySelector('[data-role="role-modal-title"]');

      function getCsrfToken(){
        const name = 'csrftoken=';
        const parts = document.cookie.split(';');
        for(let c of parts){
          const trimmed = c.trim();
          if(trimmed.startsWith(name)){ return decodeURIComponent(trimmed.substring(name.length)); }
        }
        const meta = document.querySelector('meta[name="csrf-token"]');
        return meta ? meta.getAttribute('content') : '';
      }

      function openModal(title, html){
        if(modalTitle){ modalTitle.textContent = title; }
        if(modalBody){ modalBody.innerHTML = html; }
        modal.hidden = false;
        document.body.classList.add('automation-modal-open');
        const closeButton = modal.querySelector('.automation-modal__close');
        if(closeButton){ closeButton.focus(); }
      }

      function closeModal(){
        modal.hidden = true;
        document.body.classList.remove('automation-modal-open');
      }

      modal.addEventListener('click', function(event){
        if(event.target.dataset.action === 'close-role-modal'){
          closeModal();
        }
      });

      document.addEventListener('keydown', function(event){
        if(event.key === 'Escape' && !modal.hidden){
          closeModal();
        }
      });

      function renderPermissions(data){
        if(!data){ return '<p class="muted">No modules / permissions</p>'; }
        if(data.role_modules && data.role_modules.length){
          return data.role_modules.map(function(rm){
            const perms = rm.permissions && rm.permissions.length
              ? '<ul class="role-modal-perms">' + rm.permissions.map(function(p){ return '<li>' + p.codename + '</li>'; }).join('') + '</ul>'
              : '<p class="muted">No permissions</p>';
            return '<section class="role-modal-module"><h3>' + rm.module.name + '</h3>' + perms + '</section>';
          }).join('');
        }
        if(data.modules && data.modules.length){
          return data.modules.map(function(m){
            return '<section class="role-modal-module"><h3>' + m.name + '</h3></section>';
          }).join('');
        }
        return '<p class="muted">No modules / permissions</p>';
      }

      document.querySelectorAll('[data-role-view]').forEach(function(btn){
        btn.addEventListener('click', async function(){
          const id = btn.getAttribute('data-role-view');
          try {
            const resp = await fetch(`/api/accounts/roles/${id}/`);
            if(!resp.ok){ throw new Error('Failed'); }
            const data = await resp.json();
            const body = [
              '<div class="role-modal-body-section">',
              `<p class="role-modal-meta"><span>ID:</span> ${data.id}</p>`,
              renderPermissions(data),
              '</div>'
            ].join('');
            openModal(`Role: ${data.name}`, body);
          } catch (error) {
            openModal('Error', '<p class="role-modal-error">Could not load role details.</p>');
          }
        });
      });

      function createPaginationControls(paginationId, onPrev, onNext, defaultPageSize) {
        const container = document.getElementById(paginationId);
        if (!container) return;
        container.innerHTML = '';
        const prev = document.createElement('button');
        prev.type = 'button'; prev.className = 'btn btn-sm'; prev.textContent = 'Prev';
        const info = document.createElement('span');
        info.className = 'pagination-info'; info.style.margin = '0 0.6rem';
        const next = document.createElement('button');
        next.type = 'button'; next.className = 'btn btn-sm'; next.textContent = 'Next';
        prev.addEventListener('click', onPrev); next.addEventListener('click', onNext);

        const select = document.createElement('select');
        select.className = 'pagination-pagesize';
        [10, 20, 30, 40, 50, 100].forEach((n) => {
          const opt = document.createElement('option');
          opt.value = n; opt.text = String(n);
          select.appendChild(opt);
        });
        if (defaultPageSize) select.value = String(defaultPageSize);
        select.style.marginLeft = '0.6rem';
        select.style.padding = '0.25rem 0.5rem';
        select.title = 'Rows per page';

        container.appendChild(prev);
        container.appendChild(info);
        container.appendChild(next);
        container.appendChild(select);
        return { prev, info, next, pagesize: select };
      }

      function initTablePagination(tableId, paginationId, pageSize) {
        const table = document.getElementById(tableId);
        const tbody = table && table.querySelector('tbody');
        if (!tbody) return;
        let rows = Array.from(tbody.querySelectorAll('tr')).filter((r) => !r.classList.contains('empty-row') && !r.classList.contains('empty'));
        const state = { page: 1, pageSize, rows };

        function renderPage() {
          const start = (state.page - 1) * state.pageSize;
          const end = start + state.pageSize;
          state.rows.forEach((r, i) => {
            r.style.display = (i >= start && i < end) ? '' : 'none';
          });
          const totalPages = Math.max(1, Math.ceil(state.rows.length / state.pageSize));
          controls.info.textContent = `${state.page} / ${totalPages}`;
          controls.prev.disabled = (state.page <= 1);
          controls.next.disabled = (state.page >= totalPages);
        }

        function prev() { if (state.page > 1) { state.page -= 1; renderPage(); } }
        function next() {
          const totalPages = Math.max(1, Math.ceil(state.rows.length / state.pageSize));
          if (state.page < totalPages) { state.page += 1; renderPage(); }
        }

        const controls = createPaginationControls(paginationId, prev, next, pageSize) || { prev: { disabled: true }, next: { disabled: true }, info: { textContent: '' }, pagesize: null };
        if (controls.pagesize) {
          controls.pagesize.addEventListener('change', function () {
            const v = parseInt(this.value, 10) || 10;
            state.pageSize = v;
            state.page = 1;
            renderPage();
          });
        }
        renderPage();
      }

      initTablePagination('roles-table', 'roles-pagination', 10);

      document.querySelectorAll('[data-role-delete]').forEach(function(btn){
        btn.addEventListener('click', function(){
          const id = btn.getAttribute('data-role-delete');
          openModal('Delete Role', `
            <form id="delete-role-form" class="role-confirm-form">
              <p class="role-modal-warning">Are you sure you want to delete this role?</p>
              <div class="role-confirm-actions" role="group">
                <button type="submit" class="action-button" data-variant="danger" data-testid="confirm-delete-btn">Delete</button>
                <button type="button" class="btn-secondary" data-action="close-role-modal" data-testid="cancel-delete-btn">Cancel</button>
              </div>
            </form>
          `);

          const form = document.getElementById('delete-role-form');
          if(!form){ return; }

          form.addEventListener('submit', async function(event){
            event.preventDefault();
            try {
              const resp = await fetch(`/api/accounts/roles/${id}/delete/`, {
                method: 'DELETE',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                  'X-CSRFToken': getCsrfToken()
                }
              });

              if(resp.status === 400){
                const data = await resp.json();
                form.innerHTML = `<p class="role-modal-error">${data.error || 'Cannot delete role with related records.'}</p>` +
                  '<div class="role-confirm-actions"><button type="button" class="btn-secondary" data-action="close-role-modal">Close</button></div>';
                return;
              }

              if(!resp.ok){ throw new Error('Delete failed'); }

              const row = document.querySelector(`tr[data-role-id='${id}']`);
              if(row){ row.remove(); }
              closeModal();
            } catch (error) {
              form.innerHTML = '<p class="role-modal-error">Failed to delete role.</p>' +
                '<div class="role-confirm-actions"><button type="button" class="btn-secondary" data-action="close-role-modal">Close</button></div>';
            }
          }, { once: true });
        });
      });
    });
  </script>
{% endblock %}
