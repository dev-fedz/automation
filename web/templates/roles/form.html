{% extends 'base/base.html' %}
{% load static %}
{% block title %}{{ form_title }} Role{% endblock %}

{% block head_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/automation.css' %}">
{% endblock %}

{% block content %}
<div class="automation-dashboard role-form-dashboard" id="role-form-app">
  <section class="automation-panel role-form-panel" aria-labelledby="role-form-heading" data-testid="role-form-card">
    <div class="panel-header">
      <div>
        <h2 id="role-form-heading">{{ form_title }} Role</h2>
        <p class="panel-subtitle">Configure module access and granular permissions for this role.</p>
      </div>
      <div class="panel-actions">
        <a class="action-button" href="/roles/" data-testid="back-roles">Back to Roles</a>
      </div>
    </div>

    <form method="post" class="role-form automation-form" data-testid="role-form">
      {% csrf_token %}
      <fieldset class="role-form-details">
        <legend class="sr-only">Role details</legend>
        <div class="form-row">
          <label for="role-name-input">Name</label>
          <input id="role-name-input" class="short" type="text" name="name" maxlength="60" value="{{ role.name|default:'' }}" required data-testid="role-name-input" placeholder="e.g. QA Lead" />
        </div>
      </fieldset>

      <fieldset class="modules-field">
        <legend class="sr-only">Modules and permissions</legend>
        <label>Modules & Permissions</label>
        <div class="modules-groups" data-testid="modules-picker">
          {% regroup modules by category as category_list %}
          {% for cat in category_list %}
          <div class="module-group" data-category="{{ cat.grouper }}">
            <div class="group-head">
              <h4>{{ cat.grouper }}</h4>
              <button type="button" class="group-toggle" aria-expanded="true" aria-controls="group-body-{{ forloop.counter }}">−</button>
            </div>
            <div class="group-body" id="group-body-{{ forloop.counter }}">
              {% for m in cat.list %}
              <div class="mod-item">
                <div class="mod-header">
                  <label class="mod-check">
                    <input type="checkbox" name="modules" value="{{ m.id }}" {% if m.id in selected_module_ids %}checked{% endif %}/> <span class="mod-name">{{ m.name }}</span>
                  </label>
                  {% if m.permissions %}<button type="button" class="perm-toggle" aria-label="Toggle permissions for {{ m.name }}">⚙</button>{% endif %}
                </div>
                {% if m.permissions %}
                <div class="perm-box" data-perms>
                  {% for perm in m.permissions %}
                  <label class="perm"><input type="checkbox" name="perm_{{ m.id }}" value="{{ perm.permission.id }}" {% if perm.permission.id in selected_permission_ids %}checked{% endif %}/> <span>{{ perm.permission.codename }}</span></label>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
      </fieldset>

      <div class="role-form-actions">
        <button class="btn-primary" type="submit" data-testid="role-save-btn">Save</button>
        {% if role.id %}<a class="action-button" data-variant="danger" href="/roles/{{ role.id }}/delete/" data-testid="role-delete-btn">Delete</a>{% endif %}
      </div>
    </form>
  </section>
</div>
{% endblock %}

{% block body_js %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      document.querySelectorAll('.group-toggle').forEach(function(btn){
        btn.addEventListener('click', function(){
          const body = btn.closest('.module-group').querySelector('.group-body');
          if(!body){ return; }
          const expanded = btn.getAttribute('aria-expanded') === 'true';
          body.style.display = expanded ? 'none' : 'grid';
          btn.textContent = expanded ? '+' : '−';
          btn.setAttribute('aria-expanded', expanded ? 'false' : 'true');
        });
      });

      document.querySelectorAll('.perm-toggle').forEach(function(btn){
        btn.addEventListener('click', function(){
          const box = btn.closest('.mod-item').querySelector('[data-perms]');
          if(!box){ return; }
          const hidden = box.classList.toggle('collapsed');
          if(hidden){
            box.style.maxHeight = '0';
            box.style.overflow = 'hidden';
          } else {
            box.style.maxHeight = '500px';
            box.style.overflow = 'visible';
          }
        });
      });

      document.querySelectorAll('.mod-item .mod-check input[type="checkbox"]').forEach(function(parentCb){
        parentCb.addEventListener('change', function(){
          const modItem = parentCb.closest('.mod-item');
          if(!modItem){ return; }
          const perms = modItem.querySelectorAll('[data-perms] input[type="checkbox"]');
          perms.forEach(function(p){ p.checked = parentCb.checked; });
        });
      });

      document.querySelectorAll('.mod-item [data-perms] input[type="checkbox"]').forEach(function(childCb){
        childCb.addEventListener('change', function(){
          const modItem = childCb.closest('.mod-item');
          if(!modItem){ return; }
          const parent = modItem.querySelector('.mod-check input[type="checkbox"]');
          const allPerms = modItem.querySelectorAll('[data-perms] input[type="checkbox"]');
          const anyChecked = Array.from(allPerms).some(function(p){ return p.checked; });
          parent.checked = anyChecked;
        });
      });
    });
  </script>
{% endblock %}
