{% extends 'base/base.html' %}
{% load static %}
{% block title %}Users - List{% endblock %}

{% block head_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/automation.css' %}">
{% endblock %}

{% block content %}
<div class="automation-dashboard user-management-dashboard" id="users-app">
  <section class="automation-panel user-management-panel" data-panel="users" aria-labelledby="users-heading">
    <div class="panel-header">
      <div>
        <h2 id="users-heading">Users</h2>
        <p class="panel-subtitle">Manage platform access, roles, and account status.</p>
      </div>
      <div class="panel-actions">
        {% if perms.accounts.can_add_user %}
        <a class="btn-primary" href="/users/create/" data-testid="user-create-link">Create User</a>
        {% endif %}
      </div>
    </div>

    <div class="card table-card automation-table-card" data-testid="users-card">
      <table class="table-modern automation-table" data-testid="users-table" id="users-table" aria-label="Users list">
        <thead>
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Name</th>
            <th scope="col">Email</th>
            <th scope="col">Role</th>
            <th scope="col">Status</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr data-user-id="{{ u.id }}">
            <td data-label="ID">{{ u.id }}</td>
            <td data-label="Name">
              <strong><a class="row-link" href="/users/{{ u.id }}/" data-testid="user-name-{{ u.id }}">{{ u.first_name }} {{ u.last_name }}</a></strong>
            </td>
            <td data-label="Email">
              <span class="table-secondary">{{ u.email }}</span>
            </td>
            <td data-label="Role">
              {% with r=u.groups.first %}
                {% if r %}
                  {{ r.name }}
                {% else %}
                  <span class="muted">None</span>
                {% endif %}
              {% endwith %}
            </td>
            <td data-label="Status">{{ u.get_status_display }}</td>
            <td data-label="Actions">
              <div class="table-action-group">
                {% if perms.accounts.can_change_user %}
                <a class="action-button" href="/users/{{ u.id }}/edit/" data-testid="user-edit-{{ u.id }}">Edit</a>
                {% endif %}
                {% if perms.accounts.can_delete_user %}
                <a class="action-button" data-variant="danger" href="/users/{{ u.id }}/delete/" data-testid="user-delete-{{ u.id }}">Delete</a>
                {% endif %}

                {% if not perms.accounts.can_delete_user and not perms.accounts.can_change_user %}
                <label for="">no action available</label>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="6" class="empty" data-testid="users-empty">No users found</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="table-pagination" id="users-pagination" aria-label="Users pagination"></div>
  </section>
</div>
{% endblock %}

{% block body_js %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      function createPaginationControls(paginationId, onPrev, onNext, defaultPageSize) {
        const container = document.getElementById(paginationId);
        if (!container) return;
        container.innerHTML = '';
        const prev = document.createElement('button');
        prev.type = 'button'; prev.className = 'btn btn-sm'; prev.textContent = 'Prev';
        const info = document.createElement('span');
        info.className = 'pagination-info'; info.style.margin = '0 0.6rem';
        const next = document.createElement('button');
        next.type = 'button'; next.className = 'btn btn-sm'; next.textContent = 'Next';
        prev.addEventListener('click', onPrev); next.addEventListener('click', onNext);

        const select = document.createElement('select');
        select.className = 'pagination-pagesize';
        [10, 20, 30, 40, 50, 100].forEach((n) => {
          const opt = document.createElement('option');
          opt.value = n; opt.text = String(n);
          select.appendChild(opt);
        });
        if (defaultPageSize) select.value = String(defaultPageSize);
        select.style.marginLeft = '0.6rem';
        select.style.padding = '0.25rem 0.5rem';
        select.title = 'Rows per page';

        container.appendChild(prev);
        container.appendChild(info);
        container.appendChild(next);
        container.appendChild(select);
        return { prev, info, next, pagesize: select };
      }

      function initTablePagination(tableId, paginationId, pageSize) {
        const table = document.getElementById(tableId);
        const tbody = table && table.querySelector('tbody');
        if (!tbody) return;
        let rows = Array.from(tbody.querySelectorAll('tr')).filter((r) => !r.classList.contains('empty'));
        const state = { page: 1, pageSize, rows };

        function renderPage() {
          const start = (state.page - 1) * state.pageSize;
          const end = start + state.pageSize;
          state.rows.forEach((r, i) => {
            r.style.display = (i >= start && i < end) ? '' : 'none';
          });
          const totalPages = Math.max(1, Math.ceil(state.rows.length / state.pageSize));
          controls.info.textContent = `${state.page} / ${totalPages}`;
          controls.prev.disabled = (state.page <= 1);
          controls.next.disabled = (state.page >= totalPages);
        }

        function prev() { if (state.page > 1) { state.page -= 1; renderPage(); } }
        function next() {
          const totalPages = Math.max(1, Math.ceil(state.rows.length / state.pageSize));
          if (state.page < totalPages) { state.page += 1; renderPage(); }
        }

        const controls = createPaginationControls(paginationId, prev, next, pageSize) || { prev: { disabled: true }, next: { disabled: true }, info: { textContent: '' }, pagesize: null };
        if (controls.pagesize) {
          controls.pagesize.addEventListener('change', function () {
            const v = parseInt(this.value, 10) || 10;
            state.pageSize = v;
            state.page = 1;
            renderPage();
          });
        }
        renderPage();
      }

      initTablePagination('users-table', 'users-pagination', 10);
    });
  </script>
{% endblock %}
