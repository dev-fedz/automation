{% extends 'base/base.html' %}
{% load static %}
{% block title %}User Logs{% endblock %}

{% block head_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/automation.css' %}">
{% endblock %}

{% block content %}
<div class="automation-dashboard user-management-dashboard" id="user-logs-app">
  <section class="automation-panel user-management-panel" data-panel="user-logs" aria-labelledby="user-logs-heading">
    <div class="panel-header">
      <div>
        <h2 id="user-logs-heading">User Logs</h2>
        <p class="panel-subtitle">Review user activity and system audit entries.</p>
      </div>
      <div class="panel-actions">
        <form method="get" class="automation-filter" data-testid="user-logs-filter">
          <input
            type="search"
            name="name"
            id="user-logs-name"
            class="automation-search"
            placeholder="Filter by name"
            aria-label="Filter by name"
            value="{{ name_query|default:'' }}"
          >
          <input
            type="search"
            name="action"
            id="user-logs-action"
            class="automation-search"
            placeholder="Filter by action"
            aria-label="Filter by action"
            list="user-logs-action-list"
            value="{{ action_query|default:'' }}"
          >
          <datalist id="user-logs-action-list">
            <option value=""></option>
            {% for value, label in action_choices %}
              <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </datalist>
        </form>
      </div>
    </div>

    <div class="card table-card automation-table-card" data-testid="user-logs-card">
      <table class="table-modern automation-table" data-testid="user-logs-table" id="user-logs-table" aria-label="User logs">
        <thead>
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Name</th>
            <th scope="col">Action</th>
            <th scope="col">Datetime</th>
          </tr>
        </thead>
        <tbody>
          {% if logs %}
            {% for log in logs %}
            <tr data-log-id="{{ log.id }}">
              <td data-label="ID">{{ log.id }}</td>
              <td data-label="Name">
                {{ log.user.first_name|default:"" }} {{ log.user.last_name|default:"" }}
              </td>
              <td data-label="Action">{{ log.get_action_display }}</td>
              <td data-label="Datetime">{{ log.datetime|date:"M d, Y h:i A" }}</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="4" class="empty">No user logs found.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    <div class="table-pagination" id="user-logs-pagination" aria-label="User logs pagination"></div>
  </section>
</div>
{% endblock %}

{% block body_js %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const nameInput = document.getElementById('user-logs-name');
      const actionInput = document.getElementById('user-logs-action');
      if (!nameInput || !actionInput) return;

      let debounceId;
      const applyFilters = () => {
        const params = new URLSearchParams(window.location.search);
        const nameValue = (nameInput.value || '').trim();
        const actionValue = (actionInput.value || '').trim();
        if (nameValue) {
          params.set('name', nameValue);
        } else {
          params.delete('name');
        }
        if (actionValue) {
          params.set('action', actionValue);
        } else {
          params.delete('action');
        }
        const next = `${window.location.pathname}?${params.toString()}`;
        window.location.assign(next);
      };

      nameInput.addEventListener('input', () => {
        window.clearTimeout(debounceId);
        debounceId = window.setTimeout(applyFilters, 300);
      });
      actionInput.addEventListener('change', () => {
        applyFilters();
      });

      function createPaginationControls(paginationId, onPrev, onNext, defaultPageSize) {
        const container = document.getElementById(paginationId);
        if (!container) return;
        container.innerHTML = '';
        const prev = document.createElement('button');
        prev.type = 'button'; prev.className = 'btn btn-sm'; prev.textContent = 'Prev';
        const info = document.createElement('span');
        info.className = 'pagination-info'; info.style.margin = '0 0.6rem';
        const next = document.createElement('button');
        next.type = 'button'; next.className = 'btn btn-sm'; next.textContent = 'Next';
        prev.addEventListener('click', onPrev); next.addEventListener('click', onNext);

        const select = document.createElement('select');
        select.className = 'pagination-pagesize';
        [10, 20, 30, 40, 50, 100].forEach((n) => {
          const opt = document.createElement('option');
          opt.value = n; opt.text = String(n);
          select.appendChild(opt);
        });
        if (defaultPageSize) select.value = String(defaultPageSize);
        select.style.marginLeft = '0.6rem';
        select.style.padding = '0.25rem 0.5rem';
        select.title = 'Rows per page';

        container.appendChild(prev);
        container.appendChild(info);
        container.appendChild(next);
        container.appendChild(select);
        return { prev, info, next, pagesize: select };
      }

      function initTablePagination(tableId, paginationId, pageSize) {
        const table = document.getElementById(tableId);
        const tbody = table && table.querySelector('tbody');
        if (!tbody) return;
        let rows = Array.from(tbody.querySelectorAll('tr')).filter((r) => !r.classList.contains('empty'));
        const state = { page: 1, pageSize, rows };

        function renderPage() {
          const start = (state.page - 1) * state.pageSize;
          const end = start + state.pageSize;
          state.rows.forEach((r, i) => {
            r.style.display = (i >= start && i < end) ? '' : 'none';
          });
          const totalPages = Math.max(1, Math.ceil(state.rows.length / state.pageSize));
          controls.info.textContent = `${state.page} / ${totalPages}`;
          controls.prev.disabled = (state.page <= 1);
          controls.next.disabled = (state.page >= totalPages);
        }

        function prev() { if (state.page > 1) { state.page -= 1; renderPage(); } }
        function next() {
          const totalPages = Math.max(1, Math.ceil(state.rows.length / state.pageSize));
          if (state.page < totalPages) { state.page += 1; renderPage(); }
        }

        const controls = createPaginationControls(paginationId, prev, next, pageSize) || { prev: { disabled: true }, next: { disabled: true }, info: { textContent: '' }, pagesize: null };
        if (controls.pagesize) {
          controls.pagesize.addEventListener('change', function () {
            const v = parseInt(this.value, 10) || 10;
            state.pageSize = v;
            state.page = 1;
            renderPage();
          });
        }
        renderPage();
      }

      initTablePagination('user-logs-table', 'user-logs-pagination', 10);
    });
  </script>
{% endblock %}
