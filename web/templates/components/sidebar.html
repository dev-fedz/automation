<ul class="sidebar-menu" data-testid="sidebar-menu">
    {% if perms.accounts.can_view_dashboard %}
    <li class="menu-item" data-menu="dashboard"><a href="/" data-testid="menu-dashboard">Dashboard</a></li>
    {% endif %}
    {% if 'user_accounts' in ENABLED_MODULE_CODENAMES or 'user_roles' in ENABLED_MODULE_CODENAMES %}
    <li class="has-submenu">
                <a href="#" data-testid="menu-user-mgmt">User Management</a>
        <ul class="submenu">
                        {% if 'user_accounts' in ENABLED_MODULE_CODENAMES %}
                        <li class="menu-item" data-menu="users"><a href="/users/" data-testid="menu-users">Users</a></li>
                        {% endif %}
                        {% if 'user_roles' in ENABLED_MODULE_CODENAMES %}
                        <li class="menu-item" data-menu="roles"><a href="/roles/" data-testid="menu-roles">Role</a></li>
                        {% endif %}
                        {% if 'user_logs' in ENABLED_MODULE_CODENAMES %}
                        <li class="menu-item" data-menu="user-logs"><a href="{% url 'user-logs-page' %}" data-testid="menu-user-logs">User Logs</a></li>
                        {% endif %}
        </ul>
    </li>
    {% endif %}
    {% if perms.accounts.can_use_api_tester %}
    <li class="menu-item" data-menu="api-tester"><a href="{% url 'api-tester' %}" data-testid="menu-api-tester">API Tester</a></li>
    {% endif %}
    {% if 'projects_project' in ENABLED_MODULE_CODENAMES or 'projects_module' in ENABLED_MODULE_CODENAMES or 'projects_scenario' in ENABLED_MODULE_CODENAMES or 'projects_testcase' in ENABLED_MODULE_CODENAMES %}
    <li class="has-submenu" data-menu="projects">
        <a href="#" data-testid="menu-projects">Projects</a>
        <ul class="submenu">
            {% if 'projects_project' in ENABLED_MODULE_CODENAMES %}
            <li class="menu-item" data-menu="projects-project"><a href="{% url 'automation-test-plans' %}" data-testid="menu-projects-project">Project</a></li>
            {% endif %}
            {% if 'projects_module' in ENABLED_MODULE_CODENAMES %}
            <li class="menu-item" data-menu="projects-modules"><a href="{% url 'data-management-test-modules' %}" data-testid="menu-projects-modules">Modules</a></li>
            {% endif %}
            {% if 'projects_scenario' in ENABLED_MODULE_CODENAMES %}
            <li class="menu-item" data-menu="projects-scenarios"><a href="{% url 'automation-test-scenarios' %}" data-testid="menu-projects-scenarios">Scenarios</a></li>
            {% endif %}
            {% if 'projects_testcase' in ENABLED_MODULE_CODENAMES %}
            <li class="menu-item" data-menu="projects-test-cases"><a href="{% url 'automation-test-cases' %}" data-testid="menu-projects-cases">Test Case</a></li>
            {% endif %}
        </ul>
    </li>
    {% endif %}
    <li class="has-submenu" data-menu="automation">
        <a href="#" data-testid="menu-automation">Automation</a>
        <ul class="submenu">
            <li class="menu-item" data-menu="automation-overview"><a href="{% url 'automation-overview' %}" data-testid="menu-automation-overview">Overview</a></li>
            <li class="menu-item" data-menu="automation-run"><a href="{% url 'automation-run' %}" data-testid="menu-automation-run">API Testing</a></li>
            <li class="menu-item" data-menu="automation-ui-testing"><a href="{% url 'automation-ui-testing' %}" data-testid="menu-automation-ui-testing">UI Testing</a></li>
            <li class="menu-item" data-menu="automation-load-testing"><a href="{% url 'automation-load-testing' %}" data-testid="menu-automation-load-testing">Load Testing</a></li>
            <li class="menu-item" data-menu="automation-reports"><a href="{% url 'automation-reports' %}" data-testid="menu-automation-reports">Reports</a></li>
        </ul>
    </li>
    <li class="has-submenu" data-menu="data-management">
        <a href="#" data-testid="menu-data-management">Data Management</a>
        <ul class="submenu">
            <li class="menu-item" data-menu="data-management-environments"><a href="{% url 'data-management-environments' %}" data-testid="menu-data-environments">API Environment</a></li>
        </ul>
    </li>

</ul>
<script>
document.addEventListener('DOMContentLoaded', function(){
        // submenu toggle
        document.querySelectorAll('.sidebar-menu .has-submenu > a').forEach(function(a){
            a.addEventListener('click', function(e){
                const href = this.getAttribute('href');
                if(!href || href === '#'){
                    e.preventDefault();
                }
                const li = this.parentElement;
                li.classList.toggle('open');
            });
        });
        const path = window.location.pathname.replace(/\/$/, '');
        const currentHash = window.location.hash;
        const items = document.querySelectorAll('.sidebar-menu .menu-item');
        let matched = false;
        items.forEach(function(li){
            const link = li.querySelector('a');
            if(!link) return;
            const rawHref = link.getAttribute('href') || '';
            const parts = rawHref.split('#');
            const hrefPath = parts[0] ? parts[0].replace(/\/$/, '') : '';
            const hrefHash = parts.length > 1 ? '#' + parts[1] : '';
            if(hrefPath && hrefPath === path){
                if(hrefHash && currentHash && hrefHash !== currentHash){
                    return;
                }
                if(!hrefHash && currentHash){
                    return;
                }
                li.classList.add('active');
                matched = true;
                // open & highlight parent submenu if nested
                const parentSub = li.closest('.has-submenu');
                if(parentSub) parentSub.classList.add('open','active');
            }
        });
        if(!matched){
            // default highlight the first available menu item
            const first = document.querySelector('.sidebar-menu .menu-item');
            if(first) first.classList.add('active');
        }
        // click change active
        document.querySelectorAll('.sidebar-menu a[href]').forEach(function(a){
            a.addEventListener('click', function(){
                items.forEach(li=>li.classList.remove('active'));
                const li = this.closest('.menu-item');
                if(li){ li.classList.add('active'); }
            });
        });
        // update breadcrumb in header based on active menu
        function updateBreadcrumb(){
            const breadcrumbNav = document.querySelector('.dash-header .breadcrumb');
            // don't override server-rendered breadcrumbs
            if(breadcrumbNav && breadcrumbNav.getAttribute('data-server-breadcrumbs') === '1') return;
            if(!breadcrumbNav) return;
            let activeItem = document.querySelector('.sidebar-menu .menu-item.active');
            const sep = ' <span class="sep">â€º</span> ';
            // detect actions for users and roles (map to exact labels required)
            const path = window.location.pathname.replace(/\/$/, '');
            let actionText = '';
            // Users
            if(path === '/users/create') actionText = 'Create';
            if(/^\/users\/\d+\/edit$/.test(path)) actionText = 'Update';
            if(/^\/users\/\d+$/.test(path)) actionText = 'View';
            // Roles
            if(path === '/roles/create') actionText = 'Create';
            if(/^\/roles\/\d+\/edit$/.test(path)) actionText = 'Edit';
            if(/^\/roles\/\d+$/.test(path)) actionText = 'View';

            // if no exact active menu item found (common when viewing a detail page like /users/123/),
            // try to find the best prefix match among sidebar links so breadcrumbs show the parent menu.
            if(!activeItem){
                const menuItems = Array.from(document.querySelectorAll('.sidebar-menu .menu-item'));
                let best = null;
                let bestLen = 0;
                menuItems.forEach(function(li){
                    const link = li.querySelector('a');
                    if(!link) return;
                    const rawHref = link.getAttribute('href') || '';
                    const hrefPath = rawHref.split('#')[0] ? rawHref.split('#')[0].replace(/\/$/, '') : '';
                    if(hrefPath && path.startsWith(hrefPath) && hrefPath.length > bestLen){
                        best = li; bestLen = hrefPath.length;
                    }
                });
                if(best) activeItem = best;
            }

            if(activeItem){
                const link = activeItem.querySelector('a');
                const childText = link ? link.textContent.trim() : '';
                const parentSub = activeItem.closest('.has-submenu');
                if(parentSub){
                    const parentLink = parentSub.querySelector('a');
                    const parentText = parentLink ? parentLink.textContent.trim() : '';
                    let html = '<span>Home</span>' + sep + '<span>' + parentText + '</span>' + sep + '<span>' + childText + '</span>';
                    if(actionText) html += sep + '<span>' + actionText + '</span>';
                    breadcrumbNav.innerHTML = html;
                } else {
                    let html = '<span>Home</span>' + sep + '<span>' + childText + '</span>';
                    if(actionText) html += sep + '<span>' + actionText + '</span>';
                    breadcrumbNav.innerHTML = html;
                }
                return;
            }
            // fallback
            breadcrumbNav.innerHTML = '<span>Home</span>' + sep + '<span>Dashboard</span>';
        }

        // initial breadcrumb update and also update on menu clicks
        updateBreadcrumb();
        document.querySelectorAll('.sidebar-menu a[href]').forEach(function(a){
            a.addEventListener('click', function(){
                // slight delay to allow active class logic above to run
                setTimeout(updateBreadcrumb, 10);
            });
        });
});
</script>
